<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FocusSystem Cloud</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

       ym(106183159, "init", { 
            clickmap:true, 
            trackLinks:true, 
            accurateTrackBounce:true, 
            webvisor:true, 
            triggerEvent:true 
       });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/106183159" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

    <style>
        /* --- DESIGN SYSTEM VARS --- */
       /* --- GIGACHAT DARK GLASS DESIGN SYSTEM --- */
        :root {
            --bg-dark: #0A0B10;
            --sidebar-bg: #16181D;
            --card-bg: rgba(255, 255, 255, 0.05); /* –°—Ç–µ–∫–ª—è–Ω–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç */
            --primary-color: #3E7BFF; /* –°–∏–Ω–∏–π GigaChat */
            --primary-hover: #2F61D5;
            --text-main: #FFFFFF;
            --text-secondary: #94A3B8;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.03);
            --input-border: rgba(255, 255, 255, 0.1);
            --radius-xl: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
            --danger: #FF4D4D;
            --success: #22C55E;
            --warning: #FACC15;
            --glass-blur: blur(12px);
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: linear-gradient(180deg, #1A1C24 0%, #0A0B10 100%);
            color: var(--text-main); 
            margin: 0; display: flex; height: 100vh; overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
            font-size: 15px; line-height: 1.5;
        }

        /* SPLASH SCREEN (–û–±–Ω–æ–≤–ª–µ–Ω –ø–æ–¥ —Ç–µ–º–Ω—É—é —Ç–µ–º—É) */
        #splash-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-dark);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 40px; text-align: center;
            transition: opacity 0.5s ease;
        }
        .quote-text { font-size: 18px; font-weight: 600; color: #fff; margin-bottom: 16px; font-style: italic; opacity: 0.9; }
        .quote-author { font-size: 14px; font-weight: 500; color: var(--text-secondary); }

        /* INPUTS (GigaChat Style) */
        input, textarea, select { 
            flex: 1; padding: 14px 16px; 
            border: 1px solid var(--input-border); 
            border-radius: var(--radius-md);
            font-size: 16px; font-family: 'Inter', sans-serif; 
            outline: none; background: var(--input-bg); 
            color: #fff; transition: all 0.2s;
            backdrop-filter: var(--glass-blur);
        }
        input:focus { border-color: var(--primary-color); background: rgba(255,255,255,0.07); }
        input::placeholder { color: #64748B; }
        
        .input-wrapper { background: transparent; border: none; margin-bottom: 24px; }
        .input-group { 
            display: flex; gap: 10px; padding: 6px; align-items: center; 
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-color);
            border-radius: 20px; box-sizing: border-box; 
        }
        .input-group input { border: none; background: transparent !important; backdrop-filter: none; }
        
        /* SIDEBAR (Dark Mode) */
        .sidebar { width: 260px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 32px 20px; flex-shrink: 0; overflow-y: auto; }
        .logo { font-size: 20px; font-weight: 800; margin-bottom: 40px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--primary-color); font-size: 24px; }
        .menu-item { height: 44px; padding: 0 16px; cursor: pointer; border-radius: 14px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); transition: 0.2s; }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .menu-item.active { background: rgba(62, 123, 255, 0.15); color: var(--primary-color); }
        .badge { background: rgba(255,255,255,0.1); color: #fff; padding: 2px 8px; border-radius: 99px; font-size: 11px; }

        /* MOBILE NAV (Glassmorphism) */
      /* –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨-–ö–ê–ü–°–£–õ–ê */
.bottom-nav { 
    display: none; 
    position: fixed; 
    bottom: 20px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –Ω–∏–∂–Ω–µ–≥–æ –∫—Ä–∞—è */
    left: 16px; 
    right: 16px; 
    background: rgba(30, 32, 40, 0.85); /* –¢–µ–º–Ω—ã–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω */
    backdrop-filter: blur(20px); 
    -webkit-backdrop-filter: blur(20px);
    padding: 8px 12px; 
    border-radius: 30px; /* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ –∫–∞–ø—Å—É–ª—ã */
    border: 1px solid rgba(255, 255, 255, 0.08); 
    z-index: 1000; 
    
    /* –°–∫—Ä–æ–ª–ª–∏–Ω–≥ */
    overflow-x: auto; 
    white-space: nowrap; 
    display: flex;
    align-items: center;
    gap: 4px;
    
    /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–æ—Å—É –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
    scrollbar-width: none; 
    -ms-overflow-style: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.bottom-nav::-webkit-scrollbar { display: none; }

/* –≠–õ–ï–ú–ï–ù–¢ –ú–ï–ù–Æ */
.nav-item { 
    display: inline-flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; 
    min-width: 65px; 
    padding: 6px 4px; 
    color: #94A3B8; 
    font-size: 10px; 
    font-weight: 500; 
    border-radius: 20px; 
    transition: all 0.3s ease; 
    position: relative;
    flex-shrink: 0;
}

/* –ü–û–î–°–í–ï–¢–ö–ê –í–´–ë–†–ê–ù–ù–û–ô –í–ö–õ–ê–î–ö–ò (–∫–∞–∫ –≤ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å–µ) */
.nav-item.active { 
    color: #FFFFFF; 
    background: rgba(255, 255, 255, 0.1); /* –õ–µ–≥–∫–∏–π —Ñ–æ–Ω –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
}

/* –ò–ö–û–ù–ö–ê */
.nav-icon { 
    font-size: 22px; 
    margin-bottom: 2px; 
    position: relative; 
    display: flex;
    align-items: center;
    justify-content: center;
}

/* –í–ê–®–ê –í–ò–®–ï–ù–ö–ê: –¶–í–ï–¢–ù–û–ô –Ø–†–õ–´–ß–û–ö-–ò–ù–î–ò–ö–ê–¢–û–† */
.nav-badge { 
    position: absolute; 
    top: -5px; 
    right: -8px; 
    background: var(--primary-color); /* –í–∞—à —Å–∏–Ω–∏–π —Ü–≤–µ—Ç */
    color: white; 
    font-size: 9px; 
    font-weight: 800; 
    min-width: 15px; 
    height: 15px; 
    border-radius: 10px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    padding: 0 3px; 
    border: 1.5px solid #1e2028; /* –û–±–æ–¥–æ–∫, —á—Ç–æ–±—ã –Ω–µ —Å–ª–∏–≤–∞–ª–æ—Å—å */
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

        /* MAIN AREA */
        .main { flex: 1; padding: 48px; overflow-y: auto; max-width: 900px; margin: 0 auto; box-sizing: border-box; }
        .header { margin-bottom: 32px; }
        .title { font-size: 28px; font-weight: 800; color: #fff; }
        
        /* –ö–ù–û–ü–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø GigaChat */
        .btn-add { 
            background: var(--primary-color); color: white; width: 48px; height: 48px; 
            border-radius: 16px; border: none; font-size: 24px; cursor: pointer; 
            box-shadow: 0 8px 16px rgba(62, 123, 255, 0.3); transition: 0.3s;
        }
        .btn-add:active { transform: translateY(2px); box-shadow: none; }

        /* –¢–ï –ö–ê–†–¢–û–ß–ö–ò (Glass cards) */
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .task-card { 
            background: var(--card-bg); padding: 18px; border-radius: var(--radius-xl); 
            border: 1px solid var(--border-color); backdrop-filter: var(--glass-blur);
            display: flex; justify-content: space-between; transition: 0.2s;
        }
        .task-card:hover { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.07); }
        
        .task-check { width: 24px; height: 24px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; transition: 0.2s; }
        .task-check.checked { background: var(--success); border-color: var(--success); color: white; }

        /* –Ø–†–ö–ê–Ø –ú–û–õ–ù–ò–Ø (2-–º–∏–Ω—É—Ç–∫–∏) */
        .tag.quick { 
            background: linear-gradient(90deg, #FACC15, #EAB308); 
            color: #000 !important; font-weight: 800; padding: 4px 10px;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.4); border-radius: 8px;
        }
        .tag { padding: 4px 10px; background: rgba(255,255,255,0.08); color: var(--text-secondary); border-radius: 8px; font-size: 11px; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: #1C1E26; width: 450px; padding: 32px; border-radius: 32px; border: 1px solid var(--border-color); }
        .btn-primary { 
            background: var(--primary-color); color: white; height: 52px; 
            border-radius: 16px; border: none; font-weight: 700; width: 100%;
            box-shadow: 0 8px 16px rgba(62, 123, 255, 0.2); cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div style="font-size: 48px; color: #F97316; margin-bottom: 20px;"><i class="ph-fill ph-rocket-launch"></i></div>
        <div class="quote-text" id="splash-quote">"–°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—Ö–∞ ‚Äî –Ω–∞—á–∞—Ç—å."</div>
        <div class="quote-author" id="splash-author">‚Äî –ú–∞—Ä–∫ –¢–≤–µ–Ω</div>
    </div>

    <div class="sidebar">
        <div class="logo"><i class="ph-fill ph-rocket-launch"></i> GTD Focus</div>
        
        <div class="menu-item active" onclick="switchView('inbox')"><span><i class="ph ph-tray"></i> Inbox</span><span class="badge" id="badge-inbox">0</span></div>
        <div class="menu-item" onclick="switchView('today')"><span><i class="ph ph-fire"></i> –°–µ–≥–æ–¥–Ω—è</span><span class="badge" id="badge-today">0</span></div>
        <div class="menu-item" onclick="switchView('projects')"><span><i class="ph ph-kanban"></i> –ü—Ä–æ–µ–∫—Ç—ã</span><span class="badge" id="badge-projects">0</span></div>
        <div class="spacer"></div>
        <div class="menu-item" onclick="switchView('calendar')"><span><i class="ph ph-calendar-blank"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å</span><span class="badge" id="badge-calendar">0</span></div>
        <div class="menu-item" onclick="switchView('waiting')"><span><i class="ph ph-clock-user"></i> –ü–æ—Ä—É—á–µ–Ω–∏—è</span><span class="badge" id="badge-waiting">0</span></div>
        <div class="menu-item" onclick="switchView('someday')"><span><i class="ph ph-lightbulb"></i> –ü–æ—Ç–æ–º</span><span class="badge" id="badge-someday">0</span></div>
        <div class="menu-item" onclick="switchView('reference')"><span><i class="ph ph-archive-box"></i> –ê—Ä—Ö–∏–≤</span><span class="badge" id="badge-reference">0</span></div>
        <div class="spacer"></div>
        <div class="menu-item" onclick="switchView('done')"><span><i class="ph ph-check-circle"></i> –ì–æ—Ç–æ–≤–æ</span><span class="badge" id="badge-done">0</span></div>
        <div class="menu-item" onclick="switchView('trash')"><span><i class="ph ph-trash"></i> –ö–æ—Ä–∑–∏–Ω–∞</span><span class="badge" id="badge-trash">0</span></div>
        <div class="spacer"></div>
        <div class="menu-item" onclick="openSettings()">
            <span style="color:var(--text-main)"><i class="ph ph-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </div>
    </div>

    <div class="main"><div id="app-view"></div></div>

    <nav class="bottom-nav">
        <div style="width: 10px; flex-shrink: 0;"></div>
        <div class="nav-item active" onclick="switchView('inbox')"><div class="nav-icon"><i class="ph ph-tray"></i><div class="nav-badge" id="mob-badge-inbox">0</div></div>Inbox</div>
        <div class="nav-item" onclick="switchView('today')"><div class="nav-icon"><i class="ph ph-fire"></i><div class="nav-badge" id="mob-badge-today">0</div></div>–°–µ–≥–æ–¥–Ω—è</div>
        <div class="nav-item" onclick="switchView('projects')"><div class="nav-icon"><i class="ph ph-kanban"></i><div class="nav-badge" id="mob-badge-projects">0</div></div>–ü—Ä–æ–µ–∫—Ç—ã</div>
        <div class="nav-item" onclick="switchView('calendar')"><div class="nav-icon"><i class="ph ph-calendar-blank"></i><div class="nav-badge" id="mob-badge-calendar">0</div></div>–ö–∞–ª–µ–Ω–¥.</div>
        <div class="nav-item" onclick="switchView('waiting')"><div class="nav-icon"><i class="ph ph-clock-user"></i><div class="nav-badge" id="mob-badge-waiting">0</div></div>–ü–æ—Ä—É—á.</div>
        <div class="nav-item" onclick="switchView('someday')"><div class="nav-icon"><i class="ph ph-lightbulb"></i><div class="nav-badge" id="mob-badge-someday">0</div></div>–ü–æ—Ç–æ–º</div>
        <div class="nav-item" onclick="switchView('reference')"><div class="nav-icon"><i class="ph ph-archive-box"></i><div class="nav-badge" id="mob-badge-reference">0</div></div>–ê—Ä—Ö–∏–≤</div>
        <div class="nav-item" onclick="switchView('done')"><div class="nav-icon"><i class="ph ph-check-circle"></i><div class="nav-badge" id="mob-badge-done">0</div></div>–ì–æ—Ç–æ–≤–æ</div>
        <div class="nav-item" onclick="switchView('trash')"><div class="nav-icon"><i class="ph ph-trash"></i><div class="nav-badge" id="mob-badge-trash">0</div></div>–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="nav-item" onclick="openSettings()"><div class="nav-icon"><i class="ph ph-gear"></i></div>–ú–µ–Ω—é</div>
        <div style="width: 10px; flex-shrink: 0;"></div>
    </nav>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏<i class="ph ph-x close-btn" onclick="closeModal('settings-modal')" style="cursor:pointer"></i></div>
            <div id="premium-status-box" class="premium-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <label style="display:block; font-size:11px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–ü–†–û–ú–û–ö–û–î</label>
            <div style="display:flex; gap:8px; margin-bottom:24px;">
                <input type="text" id="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" style="text-transform:uppercase;">
                <button class="btn-primary" style="width:auto; padding:0 20px;" onclick="activatePromo()">OK</button>
            </div>
            <div class="spacer"></div>
            <label style="display:block; font-size:11px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</label>
            <textarea id="feedback-text" placeholder="–ù–∞—à–ª–∏ –æ—à–∏–±–∫—É –∏–ª–∏ –µ—Å—Ç—å –∏–¥–µ—è? –ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º!" style="width:100%; box-sizing:border-box; height:80px; margin-bottom:12px; resize:none;"></textarea>
            <button class="btn-primary" style="background:#334155;" onclick="sendFeedback()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <div style="text-align:center; margin-top:20px; font-size:11px; color:var(--text-secondary);">
                FocusSystem v1.5 ‚Ä¢ Maximum Efficiency<br>
                <span id="debug-id" style="font-size: 9px; opacity: 0.5;"></span>
            </div>
        </div>
    </div>

    <div id="wizard-modal" class="modal-overlay">
        <div class="modal">
            <div style="text-align:center; font-size:11px; text-transform:uppercase; color:var(--text-secondary); margin-bottom:12px; font-weight: 800; letter-spacing:1px;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ Inbox</div>
            <div style="text-align: center; margin-bottom: 24px;"><strong id="wizard-task-text" style="font-size: 20px; line-height: 1.4;">...</strong></div>
            <div id="wizard-question-text" style="text-align:center; font-size:20px; font-weight:600; margin:32px 0;">...</div>
            <div class="wizard-buttons">
                <button class="wizard-btn" style="color:var(--danger);" onclick="handleWizardAnswer(false)" id="btn-no">–ù–µ—Ç</button>
                <button class="wizard-btn" style="color:var(--success); border-color: rgba(16, 185, 129, 0.2);" onclick="handleWizardAnswer(true)" id="btn-yes">–î–∞</button>
            </div>
            <button onclick="closeModal('wizard-modal')" style="width:100%; margin-top:20px; border:none; background:none; color:var(--text-secondary); font-size:14px; padding: 10px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
    
    <div id="project-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><span id="proj-modal-title">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</span><i class="ph ph-x close-btn" onclick="closeModal('project-modal')"></i></div>
            <div style="overflow-y:auto; flex:1;"> 
                <input type="hidden" id="proj-edit-id"> 
                <label style="display:block; font-size:11px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–ù–ê–ó–í–ê–ù–ò–ï</label>
                <input type="text" id="proj-name" style="width:100%; box-sizing:border-box; margin-bottom:20px;" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–¥–µ–ª–∞—Ç—å —Ä–µ–º–æ–Ω—Ç">
                <label style="display:block; font-size:11px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–†–ï–ó–£–õ–¨–¢–ê–¢ (–¶–ï–õ–¨)</label>
                <input type="text" id="proj-goal" placeholder="–ö–∞–∫ –ø–æ–π–º–µ—à—å, —á—Ç–æ –≥–æ—Ç–æ–≤–æ?" style="width:100%; box-sizing:border-box; margin-bottom:24px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <label style="font-size:11px; font-weight:800; color:var(--text-secondary);">–ü–ï–†–í–´–ï –®–ê–ì–ò</label>
                    <button id="btn-ai-magic" onclick="askAIForSteps()" style="border:none; background: linear-gradient(135deg, #a855f7, #ec4899); color:white; font-size:11px; font-weight:700; padding:6px 12px; border-radius:8px; cursor:pointer; display:none; box-shadow:0 2px 10px rgba(168, 85, 247, 0.3);">
                        <i class="ph-bold ph-magic-wand"></i> –ê–≤—Ç–æ-–ø–ª–∞–Ω
                    </button>
                </div>
                <div id="proj-steps-container" style="margin-bottom: 12px;"></div>
                <div style="display:flex; gap:12px; margin-bottom:24px;">
                    <input type="text" id="proj-new-step" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥..." style="flex:1;">
                    <button class="btn-primary" style="width:50px;" onclick="addStepToUI()"><i class="ph ph-plus"></i></button>
                </div>
            </div>
            <button class="btn-primary" onclick="saveProject()" style="margin-top:20px; flex-shrink:0;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        </div>
    </div>
    
    <div id="input-modal" class="modal-overlay"><div class="modal"><div class="modal-header" id="input-modal-title">–í–≤–æ–¥</div><input type="text" id="input-modal-field" style="width: 100%; box-sizing:border-box; margin-bottom: 24px;"><button class="btn-primary" onclick="submitInputModal()">–û–ö</button></div></div>
    
    <div id="date-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</div>
            <label style="font-size:12px; font-weight:700; color:var(--text-secondary); margin-bottom:4px; display:block;">–î–ê–¢–ê</label>
            <input type="date" id="calendar-date" style="width:100%; box-sizing:border-box; margin-bottom:16px;">
            <label style="font-size:12px; font-weight:700; color:var(--text-secondary); margin-bottom:4px; display:block;">–í–†–ï–ú–Ø</label>
            <input type="time" id="calendar-time" style="width:100%; box-sizing:border-box; margin-bottom:24px;">
            <button class="btn-primary" onclick="submitDateModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <div id="move-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">–ö—É–¥–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å?</div>
            <div style="display:flex; flex-direction:column; gap:8px; overflow-y:auto; max-height: 400px;"> 
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('inbox')"><span><i class="ph ph-tray"></i> Inbox</span></button>
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('today')"><span><i class="ph ph-fire"></i> –°–µ–≥–æ–¥–Ω—è</span></button>
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('calendar')"><span><i class="ph ph-calendar-blank"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('waiting')"><span><i class="ph ph-clock-user"></i> –ü–æ—Ä—É—á–µ–Ω–∏—è</span></button>
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('someday')"><span><i class="ph ph-lightbulb"></i> –ü–æ—Ç–æ–º</span></button>
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('reference')"><span><i class="ph ph-archive-box"></i> –ê—Ä—Ö–∏–≤</span></button>
            </div>
            <button onclick="closeModal('move-modal')" style="width:100%; margin-top:20px; border:none; background:none; color:var(--text-secondary); font-size:14px; padding: 10px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // üëá –¢–í–û–Ø –°–°–´–õ–ö–ê –ù–ê REPLIT
        const API_URL = 'https://636a13eb-9e28-4f04-a3b6-37318d504198-00-1eel6lm7asdp7.janeway.replit.dev'; 

        const firebaseConfig = {
            apiKey: "AIzaSyALuLfaVgYjc3rHXJz9g8TMJpO9Lzryfj4",
            authDomain: "gtd-focus-app.firebaseapp.com",
            databaseURL: "https://gtd-focus-app-default-rtdb.firebaseio.com",
            projectId: "gtd-focus-app",
            storageBucket: "gtd-focus-app.firebasestorage.app",
            messagingSenderId: "54533448500",
            appId: "1:54533448500:web:0c59c28d63ce03af1abb61",
            measurementId: "G-D0PNMT824K"
        };

        const app = initializeApp(firebaseConfig);
        const dbRef = getDatabase(app);
        const auth = getAuth(app); 
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let db = { inbox: [], today: [], calendar: [], projects: [], waiting: [], someday: [], reference: [], done: [], trash: [], premiumUntil: null };
        let currentView = 'inbox';
        let currentUserID = 'guest_user';
        let isLoaded = false; 

        // –ö–Ω–æ–ø–∫–∞ "–ö—É–ø–∏—Ç—å –≤ –±–æ—Ç–µ"
        window.closeApp = function() { if(tg) tg.close(); }

        const QUOTES = [
            { t: "–°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—Ö–∞ ‚Äî –Ω–∞—á–∞—Ç—å.", a: "–ú–∞—Ä–∫ –¢–≤–µ–Ω" },
            { t: "–î–µ–ª–∞–π —Ç–æ, —á—Ç–æ –º–æ–∂–µ—à—å, —Å —Ç–µ–º, —á—Ç–æ –∏–º–µ–µ—à—å.", a: "–¢–µ–æ–¥–æ—Ä –†—É–∑–≤–µ–ª—å—Ç" },
            { t: "–ó–∞–Ω—è—Ç–æ—Å—Ç—å –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.", a: "–¢–∏–º –§–µ—Ä—Ä–∏—Å" },
            { t: "–¢–≤–æ–π –º–æ–∑–≥ ‚Äî –¥–ª—è –∏–¥–µ–π, –∞ –Ω–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è.", a: "–î—ç–≤–∏–¥ –ê–ª–ª–µ–Ω" },
            { t: "–§–æ–∫—É—Å ‚Äî —ç—Ç–æ —Å–∫–∞–∑–∞—Ç—å '–Ω–µ—Ç'.", a: "–°—Ç–∏–≤ –î–∂–æ–±—Å" }
        ];

        function initSplash() {
            const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            document.getElementById('splash-quote').innerText = `"${q.t}"`;
            document.getElementById('splash-author').innerText = `‚Äî ${q.a}`;
            setTimeout(() => {
                const s = document.getElementById('splash-screen');
                s.style.opacity = '0';
                setTimeout(() => s.style.display = 'none', 500);
            }, 2000);
        }

        // üëá –í–°–¢–ê–í–¨ –≠–¢–û –í–ú–ï–°–¢–û –°–¢–ê–†–û–ô initUserInfo
        async function initUserInfo() {
            const user = tg.initDataUnsafe?.user;
            
            if (user) {
                currentUserID = String(user.id);
                const name = user.first_name;
                const logoEl = document.querySelector('.logo');
                if (logoEl) logoEl.innerHTML = `<i class="ph-fill ph-rocket-launch"></i> ${name}'s Focus`;
                if (typeof ym !== 'undefined') ym(106183159, 'userParams', { UserID: user.id });

                try {
                    // 1. –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω
                    // –î–æ–±–∞–≤–∏–ª–∏ alert –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Å—Ç–∞—Ä—Ç–∞
                    // alert("1. –ó–∞–ø—Ä–æ—Å —Ç–æ–∫–µ–Ω–∞..."); 
                    
                    const response = await fetch(`${API_URL}/api/auth`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ initData: tg.initData }) 
                    });
                    
                    if (!response.ok) {
                        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—Ç–∏–ª –æ—à–∏–±–∫–æ–π (403, 500 –∏ —Ç.–¥.)
                        const errText = await response.text();
                        alert(`‚ùå –û—à–∏–±–∫–∞ –°–µ—Ä–≤–µ—Ä–∞ Replit:\nStatus: ${response.status}\nText: ${errText}`);
                        throw new Error(`Server Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    if (!data.token) {
                         alert("‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∏—Å–ª–∞–ª —Ç–æ–∫–µ–Ω (Token is empty)");
                         throw new Error("No token received");
                    }

                    // 2. –í—Ö–æ–¥–∏–º –≤ Firebase
                    await signInWithCustomToken(auth, data.token);
                    
                    // –ï–°–õ–ò –ú–´ –ó–î–ï–°–¨ - –ó–ù–ê–ß–ò–¢ –í–°–Å –†–ê–ë–û–¢–ê–ï–¢
                    // alert("‚úÖ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê!"); 
                    console.log("‚úÖ Auth Success");

                } catch (e) {
                    // üëá –í–û–¢ –≠–¢–û –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï: –ü–û–ö–ê–ñ–ò –ú–ù–ï –≠–¢–û–¢ ALERT
                    console.error(e);
                    alert(`üö® –û—à–∏–±–∫–∞ –í—Ö–æ–¥–∞:\n${e.message}\n\n–ü—Ä–æ–≤–µ—Ä—å –∫–æ–Ω—Å–æ–ª—å Replit!`);
                }
            } else {
                let storedId = localStorage.getItem('gtd_guest_id');
                if(!storedId) { storedId = 'web_' + Date.now(); localStorage.setItem('gtd_guest_id', storedId); }
                currentUserID = storedId;
            }
            
            // 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ)
            let userPathId = currentUserID;
            if (auth.currentUser) {
                userPathId = auth.currentUser.uid;
            }
            
            const userRef = ref(dbRef, 'users/' + userPathId);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    db = { ...db, ...data };
                    if(!Array.isArray(db.inbox)) db.inbox = Object.values(db.inbox || {});
                    if(!Array.isArray(db.today)) db.today = Object.values(db.today || {});
                    if(!Array.isArray(db.projects)) db.projects = Object.values(db.projects || {});
                } 
                isLoaded = true; 
                updateBadges();
                renderCurrentView();
                const debugEl = document.getElementById('debug-id');
                if(debugEl) debugEl.innerText = 'ID: ' + userPathId;
            });
        }

        // –ó–ê–©–ò–©–ï–ù–ù–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï
        function saveDB() {
            if (!isLoaded) return;
            
            const dataToSave = { 
                inbox: db.inbox || [],
                today: db.today || [],
                calendar: db.calendar || [],
                projects: db.projects || [],
                waiting: db.waiting || [],
                someday: db.someday || [],
                reference: db.reference || [],
                done: db.done || [],
                trash: db.trash || [],
                // –í–ê–ñ–ù–û: –ú—ã –ù–ï –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º premiumUntil –∏ isPremium
            };
            
            const userPathId = auth.currentUser?.uid || currentUserID;
            update(ref(dbRef, 'users/' + userPathId), dataToSave).catch(e => console.error("Save Error:", e));
            updateBadges();
            renderCurrentView();
        }

        function checkPremiumLimits() {
            if (db.premiumUntil && new Date(db.premiumUntil) > new Date()) return true;
            if (db.isPremium === true && !db.premiumUntil) return true;
            const activeProjects = (db.projects || []).filter(p => !p.completedAt).length;
            if (activeProjects >= 3) {
                alert("üíé –õ–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏!\n\n–¢–æ–ª—å–∫–æ 3 –ø—Ä–æ–µ–∫—Ç–∞. –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.");
                return false; 
            }
            return true;
        }

        window.openSettings = function() {
            document.getElementById('settings-modal').style.display = 'flex';
            const statusBox = document.getElementById('premium-status-box');
            if (db.premiumUntil && new Date(db.premiumUntil) > new Date()) {
                const date = new Date(db.premiumUntil).toLocaleDateString();
                statusBox.className = 'premium-status active';
                statusBox.innerHTML = `üíé <b>Premium –∞–∫—Ç–∏–≤–µ–Ω</b><br>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: ${date}`;
            } else {
                statusBox.className = 'premium-status expired';
                statusBox.innerHTML = `üåë <b>–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è</b><br>–õ–∏–º–∏—Ç: 3 –ø—Ä–æ–µ–∫—Ç–∞. –ù–µ—Ç AI.<br><div onclick="closeApp()" style="color:#991B1B; font-weight:800; text-decoration:underline; cursor:pointer; margin-top:8px;">üëâ –ö–£–ü–ò–¢–¨ –í –ë–û–¢–ï</div>`;
            }
            
            // –ß–∏—Å—Ç—ã–π Support ID
            const debugEl = document.getElementById('debug-id');
            const uid = auth.currentUser?.uid || currentUserID;
            if(debugEl) debugEl.innerText = 'Support ID: ' + uid;
        }

        window.activatePromo = async function() {
            const code = document.getElementById('promo-input').value.trim();
            if (!code) return;
            const btn = document.querySelector('#settings-modal .btn-primary');
            btn.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
            try {
                const res = await fetch(`${API_URL}/api/promo`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId: currentUserID, code: code })
                });
                const data = await res.json();
                if (data.success) { 
                    alert('üéâ ' + data.message); 
                    if (data.newPremiumUntil) {
                        db.premiumUntil = data.newPremiumUntil;
                        db.isPremium = true;
                        openSettings(); 
                    }
                    closeModal('settings-modal'); 
                } 
                else { alert('‚ùå ' + data.message); }
            } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); } 
            btn.innerHTML = 'OK';
        }

        window.sendFeedback = async function() {
            const text = document.getElementById('feedback-text').value.trim();
            if(!text) return;
            const username = tg.initDataUnsafe?.user?.username || 'hidden';
            try {
                await fetch(`${API_URL}/api/feedback`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        userId: currentUserID, 
                        text: text, 
                        name: tg.initDataUnsafe?.user?.first_name || 'Guest',
                        username: username 
                    })
                });
                alert("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!"); 
                document.getElementById('feedback-text').value = ''; 
                closeModal('settings-modal');
            } catch(e) { console.error(e); alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"); }
        }

        window.haptic = function(style = 'light') { try { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred(style); } catch(e){} }
        window.formatDateRUS = function(isoDate) { if(!isoDate) return ''; const parts = isoDate.split('-'); if(parts.length !== 3) return isoDate; return `${parts[2]}.${parts[1]}.${parts[0]}`; }
        
       window.switchView = function(view) {
    window.haptic('light'); 
    currentView = view;
    
    // 1. –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));

    // 2. –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–º—É (–º–æ–±–∏–ª—å–Ω–æ–º –∏ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–º)
    const activeNavs = document.querySelectorAll(`[onclick="switchView('${view}')"]`);
    activeNavs.forEach(el => el.classList.add('active'));

    // 3. –°–∫—Ä–æ–ª–ª–∏–º –ø–∞–Ω–µ–ª—å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É, –µ—Å–ª–∏ –æ–Ω —Å–∫—Ä—ã—Ç
    const targetNav = document.querySelector(`.nav-item.active`);
    if (targetNav) {
        targetNav.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }

    renderCurrentView();
}

        window.renderCurrentView = function() {
            const container = document.getElementById('app-view');
            const headers = { 'inbox': 'üì• –í—Ö–æ–¥—è—â–∏–µ', 'today': 'üî• –°–µ–≥–æ–¥–Ω—è', 'calendar': 'üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å', 'projects': 'üèó –ü—Ä–æ–µ–∫—Ç—ã', 'waiting': 'üëÄ –ñ–¥—É –æ—Ç–≤–µ—Ç–∞', 'someday': 'üí° –û–¥–Ω–∞–∂–¥—ã', 'reference': 'üìö –ê—Ä—Ö–∏–≤', 'done': '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ', 'trash': 'üóë –ö–æ—Ä–∑–∏–Ω–∞' };
            let html = `<div class="header"><div class="title">${headers[currentView]}</div>`;
            if (currentView === 'done' && (db.done && db.done.length > 0)) html += `<button class="btn-action delete" onclick="emptyDone()" style="width:auto; padding:0 10px; font-size:13px;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>`;
            if(currentView === 'trash' && db.trash && db.trash.length > 0) html += `<button class="btn-action delete" onclick="emptyTrash()" style="width:auto; padding:0 10px; font-size:13px;">–û—á–∏—Å—Ç–∏—Ç—å</button>`;
            html += `</div>`;
            
            if(!db[currentView]) db[currentView] = [];
            if (currentView === 'inbox') {
                html += `<div class="input-wrapper"><div class="input-group"><input type="text" id="main-input" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" onkeypress="if(event.key==='Enter') addTask()"><button class="btn-add" onclick="addTask()"><i class="ph ph-plus"></i></button></div></div>`;
                if(db.inbox.length > 0) html += `<button class="btn-wizard" onclick="startWizard()"><i class="ph ph-lightning"></i> –†–∞–∑–æ–±—Ä–∞—Ç—å –ò–Ω–±–æ–∫—Å (${db.inbox.length})</button>`;
            }
            html += `<div class="task-list">`;
            const list = db[currentView] || [];
            if(list.length === 0) { html += `<div style="text-align:center; color:var(--text-secondary); margin-top:60px; font-size:15px; opacity:0.6;"><i class="ph ph-coffee" style="font-size:40px; margin-bottom:10px; display:block;"></i>–ó–∞–¥–∞—á –Ω–µ—Ç</div>`; } else {
                if (currentView === 'done') {
                    const doneProjects = list.filter(i => i.isProject);
                    const doneTasks = list.filter(i => !i.isProject);
                    if (doneProjects.length > 0) { html += `<div class="section-title">–ü—Ä–æ–µ–∫—Ç—ã</div>`; doneProjects.forEach(item => { html += createCard(item, true, true); }); }
                    if (doneTasks.length > 0) { html += `<div class="section-title">–ó–∞–¥–∞—á–∏</div>`; doneTasks.forEach(item => { html += createCard(item, true, false); }); }
                } else if (currentView === 'projects') {
                     list.forEach(item => {
                        if(!item.steps) item.steps = [];
                        const activeStep = item.steps.find(s => !s.completed);
                        const progress = item.steps.filter(s=>s.completed).length + '/' + item.steps.length;
                        html += `<div class="task-card" style="display:block;"><div style="display:flex; justify-content:space-between; margin-bottom:12px;"><div style="font-weight:700; font-size:17px; color:var(--text-main);"><i class="ph ph-folder-notch"></i> ${item.title}</div><div class="actions"><button class="btn-action" onclick="editProject(${item.id})"><i class="ph ph-pencil-simple"></i></button><button class="btn-action delete" onclick="moveToTrash('${currentView}', ${item.id})"><i class="ph ph-trash"></i></button></div></div><div style="font-size:14px; color:var(--text-secondary); margin-bottom:12px;">üéØ ${item.goal}</div><div style="background:#F8FAFC; padding:12px; border-radius:12px; font-size:14px; display:flex; justify-content:space-between; align-items:center;"><span style="display:flex; gap:8px; align-items:center;"><i class="ph ph-footprints" style="color:var(--primary-color)"></i> ${activeStep ? activeStep.text : '–ì–æ—Ç–æ–≤–æ!'}</span><span style="font-size:12px; font-weight:600; color:var(--text-secondary);">${progress}</span></div></div>`;
                      });
                } else { 
                    list.forEach((item, index) => { 
                        let prefix = '';
                        if(currentView === 'inbox') prefix = `<span class="task-num">${index+1}.</span>`;
                        html += createCard(item, false, false, prefix); 
                    }); 
                }
            }
            html += `</div>`; container.innerHTML = html; updateBadges();
        }

        window.createCard = function(item, isDoneView, isProjectCard, prefixHtml = '') {
            let metaHtml = '';
            if(item.isQuick) metaHtml += `<span class="tag quick"><i class="ph-fill ph-lightning"></i> 2 –º–∏–Ω</span>`;
            if(item.dateStr) metaHtml += `<span class="tag date"><i class="ph-fill ph-calendar"></i> ${formatDateRUS(item.dateStr)}</span>`;
            if(item.timeStr) metaHtml += `<span class="tag date"><i class="ph-fill ph-clock"></i> ${item.timeStr}</span>`;
            if(item.assignee) metaHtml += `<span class="tag project"><i class="ph-fill ph-user"></i> ${item.assignee}</span>`;
            if(item.projectTitle) metaHtml += `<span class="tag project"><i class="ph-fill ph-folder"></i> ${item.projectTitle}</span>`;
            
            let buttons = '';
            // üëá –ö–ù–û–ü–ö–ê AI-–ú–ê–ì–ò–ò
            if(!['trash','done'].includes(currentView)) { 
                buttons += `<button class="btn-action ai-magic" onclick="magicDecompose(${item.id})"><i class="ph-bold ph-magic-wand"></i></button>`;
                buttons += `<button class="btn-action" onclick="openMoveModal(${item.id})"><i class="ph ph-folder-notch-open"></i></button>`; 
            }

            if(currentView === 'trash') { buttons += `<button class="btn-action" onclick="restoreFromTrash(${item.id})"><i class="ph ph-arrow-u-up-left"></i></button><button class="btn-action delete" onclick="permanentDelete(${item.id})"><i class="ph ph-x"></i></button>`; } else if (isDoneView) { buttons += `<button class="btn-action" onclick="undoComplete(${item.id})"><i class="ph ph-arrow-u-up-left"></i></button>`; buttons += `<button class="btn-action delete" onclick="moveToTrash('done', ${item.id})"><i class="ph ph-trash"></i></button>`; } else { buttons += `<button class="btn-action delete" onclick="moveToTrash('${currentView}', ${item.id})"><i class="ph ph-trash"></i></button>`; }

            const displayTitle = item.title || item.text;
            const checkAction = `completeTask('${currentView}', ${Number(item.id)})`;
            let checkboxHtml = '';
            if(['today','calendar','inbox','waiting','someday'].includes(currentView)) { checkboxHtml = `<div class="task-check" onclick="${checkAction}"><i class="ph-bold ph-check"></i></div>`; } else if (isDoneView) { checkboxHtml = `<div class="task-check checked"><i class="ph-bold ph-check"></i></div>`; }
            return `<div class="task-card"><div class="task-left">${checkboxHtml}<div class="task-content"><div class="task-title" style="${isDoneView?'text-decoration:line-through; opacity:0.5':''}"> ${prefixHtml} ${displayTitle} </div><div class="task-meta">${metaHtml}</div></div></div><div class="actions">${buttons}</div></div>`;
        }

        // üëá –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–†–ï–í–†–ê–©–ï–ù–ò–ï –ó–ê–î–ê–ß–ò –í –ü–†–û–ï–ö–¢ –° –ü–û–ú–û–©–¨–Æ –ò–ò
        window.magicDecompose = async function(id) {
            if (!checkPremiumLimits()) return;
            const task = db[currentView].find(t => t.id === id);
            if(!task) return;

            if(!confirm(`ü™Ñ –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –∑–∞–¥–∞—á—É "${task.text}" –≤ –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç?`)) return;
            window.haptic('medium');
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø—Ä–æ–µ–∫—Ç–∞ –∏ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞–µ–º AI
            openProjectModal(null, task);
            setTimeout(() => {
                askAIForSteps();
            }, 500);
        }

        window.addTask = function() { window.haptic('light'); const val = document.getElementById('main-input').value.trim(); if(!val) return; if(!db.inbox) db.inbox = []; db.inbox.unshift({ id: Date.now(), text: val, created: new Date().toISOString(), isProject: false }); document.getElementById('main-input').value = ''; renderCurrentView(); saveDB(); }
        window.moveToTrash = function(from, id) { window.haptic('medium'); const idx = db[from].findIndex(t => t.id === id); if(idx > -1) { const item = db[from].splice(idx, 1)[0]; item.originalFolder = from; if(!db.trash) db.trash = []; db.trash.unshift(item); renderCurrentView(); saveDB(); } }
        window.restoreFromTrash = function(id) { window.haptic('light'); const idx = db.trash.findIndex(t => t.id === id); if(idx > -1) { const item = db.trash.splice(idx, 1)[0]; db[item.originalFolder || 'inbox'].push(item); renderCurrentView(); saveDB(); } }
        window.permanentDelete = function(id) { window.haptic('heavy'); if(confirm("–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?")) { db.trash = db.trash.filter(t => t.id !== id); renderCurrentView(); saveDB(); } }
        window.emptyDone = function() { if(confirm("–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –≤ –∫–æ—Ä–∑–∏–Ω—É?")) { if(!db.trash) db.trash = []; db.trash.push(...db.done.map(i => ({...i, originalFolder: 'done'}))); db.done = []; renderCurrentView(); saveDB(); } }
        window.emptyTrash = function() { window.haptic('heavy'); if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?")) { db.trash = []; renderCurrentView(); saveDB(); } }
        window.undoComplete = function(id) { window.haptic('light'); const idx = db.done.findIndex(t => t.id === id); if(idx > -1) { const item = db.done.splice(idx, 1)[0]; delete item.completedAt; if(item.isProject) db.projects.unshift(item); else db.today.unshift(item); renderCurrentView(); saveDB(); } }
        window.completeTask = function(from, id) { window.haptic('success'); id = Number(id); const idx = db[from].findIndex(t => t.id === id); if(idx === -1) return; const task = db[from][idx]; if (task.projectId) { const project = db.projects.find(p => p.id === task.projectId); if (project) { const step = project.steps.find(s => s.id === task.stepId); if(step) step.completed = true; const nextStep = project.steps.find(s => !s.completed); if(nextStep) { alert(`–û—Ç–ª–∏—á–Ω–æ! –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: "${nextStep.text}"`); db.today.push({ id: Date.now(), text: nextStep.text, projectId: project.id, projectTitle: project.title, stepId: nextStep.id, isProject: false }); } else { alert("üéâ –ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"); db.projects = db.projects.filter(p => p.id !== project.id); project.isProject = true; project.completedAt = new Date().toLocaleString(); if(!db.done) db.done = []; db.done.unshift(project); } } db[from].splice(idx, 1); } else { const item = db[from].splice(idx, 1)[0]; item.completedAt = new Date().toLocaleString(); if(!db.done) db.done = []; db.done.unshift(item); } renderCurrentView(); saveDB(); }

        let wizardTask=null, wizardStep=0, inputCallback=null, dateCallback=null, moveTaskId=null;
        const questions = [ { text: "–ù—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å?", no: "reference", noTxt: "–ù–µ—Ç (–ê—Ä—Ö–∏–≤)", yesTxt: "–î–∞" }, { text: "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ?", no: "someday", noTxt: "–ù–µ—Ç (–ü–æ—Ç–æ–º)", yesTxt: "–î–∞" }, { text: "–î–µ–ª–∞—Ç—å –ú–ù–ï?", no: "DELEGATE", noTxt: "–ù–µ—Ç (–ü–æ—Ä—É—á–∏—Ç—å)", yesTxt: "–î–∞" }, { text: "–≠—Ç–æ 1 —à–∞–≥?", no: "PROJECT", noTxt: "–ù–µ—Ç (–ü—Ä–æ–µ–∫—Ç)", yesTxt: "–î–∞" }, { text: "< 2 –º–∏–Ω—É—Ç?", yes: "DO_NOW", yesTxt: "–î–∞ (–°–µ–π—á–∞—Å)", noTxt: "> 2 –º–∏–Ω" }, { text: "–ñ–µ—Å—Ç–∫–∞—è –¥–∞—Ç–∞?", yes: "CALENDAR", yesTxt: "–î–∞ (–ö–∞–ª–µ–Ω–¥–∞—Ä—å)", noTxt: "–ù–µ—Ç (–í –°–µ–≥–æ–¥–Ω—è)" } ];
        
        window.startWizard = function() { if(db.inbox.length===0) return; window.haptic('light'); wizardTask=db.inbox[db.inbox.length - 1]; wizardStep=0; document.getElementById('wizard-modal').style.display='flex'; renderWizard(); }
        window.renderWizard = function() { const q = questions[wizardStep]; document.getElementById('wizard-task-text').innerText = wizardTask.text; document.getElementById('wizard-question-text').innerText = q.text; document.getElementById('btn-no').innerText = q.noTxt; document.getElementById('btn-yes').innerText = q.yesTxt; }
        window.handleWizardAnswer = function(yes) { window.haptic('light'); const q = questions[wizardStep]; if(!yes) { if(q.no==='reference') return moveTo('reference'); if(q.no==='someday') return moveTo('someday'); if(q.no==='DELEGATE') { openInput('–ö–æ–º—É?', (n)=>{ setTimeout(()=>openDateModal((d)=>moveTo('waiting',{assignee:n, dateStr:d})),200); }); return; } if(q.no==='PROJECT') { openProjectModal(null, wizardTask); return; } } else { if(q.yes==='DO_NOW') { moveTo('today', { isQuick: true }); alert("‚ö°Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ '–°–µ–≥–æ–¥–Ω—è' (2 –ú–ò–ù). –°–¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ —Å–µ–π—á–∞—Å!"); return; } if(q.yes==='CALENDAR') { openDateModal((d,t)=>moveTo('calendar',{dateStr:d, timeStr:t})); return; } } wizardStep++; if(wizardStep>=questions.length) moveTo('today'); else renderWizard(); }
        window.moveTo = function(f, e={}) { db.inbox = db.inbox.filter(t => t.id !== wizardTask.id); if(!db[f]) db[f]=[]; db[f].unshift({...wizardTask, ...e, id:Date.now()}); renderCurrentView(); saveDB(); closeModal('wizard-modal'); closeModal('input-modal'); closeModal('date-modal'); if(db.inbox.length>0) setTimeout(startWizard,300); }
        window.closeModal = function(id) { document.getElementById(id).style.display='none'; }
        window.openInput = function(t, cb) { document.getElementById('input-modal').style.display='flex'; document.getElementById('input-modal-title').innerText=t; inputCallback=cb; }
        window.submitInputModal = function() { const v=document.getElementById('input-modal-field').value; if(v&&inputCallback) inputCallback(v); closeModal('input-modal'); }
        window.openDateModal = function(cb) { document.getElementById('date-modal').style.display='flex'; dateCallback=cb; }
        window.submitDateModal = function() { const d=document.getElementById('calendar-date').value; const t=document.getElementById('calendar-time').value; if(d&&dateCallback) dateCallback(d,t); closeModal('date-modal'); }
        window.openMoveModal = function(id) { moveTaskId=id; document.getElementById('move-modal').style.display='flex'; }
        window.submitMove = function(f) { if(!moveTaskId)return; const idx=db[currentView].findIndex(t=>t.id===moveTaskId); if(idx>-1) { const i=db[currentView].splice(idx,1)[0]; if(!db[f]) db[f]=[]; db[f].unshift(i); renderCurrentView(); saveDB(); } closeModal('move-modal'); }

        let tempSteps=[];
        window.openProjectModal = function(eid=null, src=null) { closeModal('wizard-modal'); document.getElementById('project-modal').style.display='flex'; tempSteps=[]; const aiBtn = document.getElementById('btn-ai-magic'); if(aiBtn) aiBtn.style.display = checkPremiumLimits() ? 'block' : 'none'; if(eid) { const p=db.projects.find(x=>x.id===eid); document.getElementById('proj-edit-id').value=eid; document.getElementById('proj-name').value=p.title; document.getElementById('proj-goal').value=p.goal; tempSteps=JSON.parse(JSON.stringify(p.steps)); } else { document.getElementById('proj-edit-id').value=""; document.getElementById('proj-name').value=src ? src.text : ''; document.getElementById('proj-goal').value=""; } renderSteps(); }
        window.addStepToUI = function() { const v=document.getElementById('proj-new-step').value; if(v) { tempSteps.push({id:Date.now(), text:v, completed:false}); document.getElementById('proj-new-step').value=''; renderSteps(); } }
        window.removeStep = function(i) { tempSteps.splice(i,1); renderSteps(); }
        window.renderSteps = function() { const c=document.getElementById('proj-steps-container'); c.innerHTML=''; tempSteps.forEach((s,i)=>{ c.innerHTML+=`<div class="step-row"><span>${i+1}.</span><input value="${s.text}" oninput="updateStep(${i},this.value)" style="border:none; background:transparent; font-size:15px; width:100%; outline:none;"><i class="ph ph-x" style="color:red; font-size:18px; padding:5px; cursor:pointer;" onclick="removeStep(${i})"></i></div>`; }); }
        window.updateStep = function(i,v) { tempSteps[i].text=v };

        window.askAIForSteps = async function() {
            const title = document.getElementById('proj-name').value;
            if(!title) return alert("–°–Ω–∞—á–∞–ª–∞ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞!");
            const btn = document.getElementById('btn-ai-magic');
            const oldText = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> –î—É–º–∞—é...';
            btn.disabled = true;
            try {
                const response = await fetch(`${API_URL}/api/ask-ai`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: `–Ø —Å–æ–∑–¥–∞—é –ø—Ä–æ–µ–∫—Ç: "${title}".`, initData: tg.initData }) });
                if (response.status === 402) { alert("‚õîÔ∏è –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ù–∞—Å—Ç—Ä–æ–π–∫–∏."); return; }
                if (response.status === 403) { alert("‚õîÔ∏è –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞. –ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω."); return; }
                const data = await response.json();
                if(data.reply) { const lines = data.reply.split('\n').filter(line => line.trim().length > 0); lines.forEach(line => { const cleanText = line.replace(/^[\d\.\-\s]+/, ''); tempSteps.push({id: Date.now() + Math.random(), text: cleanText, completed: false}); }); renderSteps(); window.haptic('success'); }
            } catch (e) { console.error(e); alert("–û—à–∏–±–∫–∞ –ò–ò"); } finally { btn.innerHTML = oldText; btn.disabled = false; }
        }
        
        window.saveProject = function() { window.haptic('success'); const eid=document.getElementById('proj-edit-id').value; if (!eid) { if (!checkPremiumLimits()) return; } const t=document.getElementById('proj-name').value; const g=document.getElementById('proj-goal').value; if(!t||!g||tempSteps.length===0) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–ª—å –∏ —à–∞–≥–∏!"); if(eid) { const i=db.projects.findIndex(p=>p.id==eid); if(i>-1) { db.projects[i].title=t; db.projects[i].goal=g; db.projects[i].steps=tempSteps; } } else { const nid=Date.now(); if(!db.projects) db.projects = []; db.projects.push({id:nid, title:t, goal:g, steps:tempSteps, isProject:true}); if(wizardTask) { if(!db.inbox) db.inbox = []; db.inbox=db.inbox.filter(x=>x.id!==wizardTask.id); } if(!db.today) db.today = []; db.today.push({id:Date.now()+1, text:tempSteps[0].text, projectId:nid, projectTitle:t, stepId:tempSteps[0].id, isProject:false}); } renderCurrentView(); saveDB(); closeModal('project-modal'); if(!eid&&db.inbox.length>0) setTimeout(startWizard,300); }
        window.editProject = function(id) { openProjectModal(id); }
        window.updateBadges = function() { const views = ['inbox', 'today', 'calendar', 'projects', 'waiting', 'someday', 'reference', 'done', 'trash']; views.forEach(view => { const el = document.getElementById('badge-' + view); if(el) el.innerText = db[view] ? db[view].length : 0; const mobEl = document.getElementById('mob-badge-' + view); if(mobEl) { const count = db[view] ? db[view].length : 0; mobEl.innerText = count; mobEl.style.display = count > 0 ? 'flex' : 'none'; } }); }
        
        initSplash();
        initUserInfo(); switchView('inbox');
    </script>
</body>
</html>




