<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FocusSystem AI 3.6 Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

       ym(106183159, "init", { clickmap:true, trackLinks:true, accurateTrackBounce:true, webvisor:true, triggerEvent:true });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/106183159" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

    <style>
        /* --- DESIGN SYSTEM VARS --- */
        :root {
            --bg-dark: #0A0B10;
            --sidebar-bg: #16181D;
            --card-bg: rgba(255, 255, 255, 0.05);
            --primary-color: #3E7BFF;
            --primary-hover: #2F61D5;
            --text-main: #FFFFFF;
            --text-secondary: #94A3B8;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.03);
            --input-border: rgba(255, 255, 255, 0.1);
            --radius-xl: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
            --danger: #FF4D4D;
            --success: #22C55E;
            --warning: #FACC15;
            --glass-blur: blur(12px);
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: linear-gradient(180deg, #1A1C24 0%, #0A0B10 100%);
            color: var(--text-main); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            height: 100dvh; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
            font-size: 16px; line-height: 1.5;
        }

        /* 3D CANVAS & SPLASH */
        #splash-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-dark);
            z-index: 9999; display: flex; flex-direction: column;
            align-items: center; justify-content: center; padding: 40px; text-align: center;
            transition: opacity 0.8s ease;
        }
        #bg-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none; opacity: 0; transition: opacity 1s ease;
        }
        #splash-screen canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
        }
        .splash-content { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .quote-text { font-size: 20px; font-weight: 600; color: #fff; margin-bottom: 16px; font-style: italic; opacity: 0.9; text-shadow: 0 4px 20px rgba(0,0,0,1); }
        .quote-author { font-size: 15px; font-weight: 500; color: var(--primary-color); text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 2px 10px rgba(0,0,0,1); }

        /* INPUTS */
        input, textarea, select { 
            flex: 1; padding: 14px 16px; 
            border: 1px solid var(--input-border); 
            border-radius: var(--radius-md);
            font-size: 17px; font-family: 'Inter', sans-serif; 
            outline: none; background: var(--input-bg); 
            color: #fff; transition: all 0.2s;
            backdrop-filter: var(--glass-blur);
        }
        input:focus, textarea:focus { border-color: var(--primary-color); background: rgba(255,255,255,0.07); }
        input::placeholder, textarea::placeholder { color: #64748B; }
        
        .input-wrapper { background: transparent; border: none; margin-bottom: 24px; position: relative; z-index: 10; }
        .input-group { 
            display: flex; gap: 8px; padding: 6px; align-items: center; 
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-color);
            border-radius: 20px; box-sizing: border-box; backdrop-filter: blur(10px);
        }
        .input-group input { border: none; background: transparent !important; backdrop-filter: none; padding-left: 12px; }
        
        /* SIDEBAR */
        .sidebar { 
            width: 280px; background: var(--sidebar-bg); border-right: 1px solid var(--border-color); 
            display: flex; flex-direction: column; padding: 32px 20px; flex-shrink: 0; overflow-y: auto; z-index: 10;
        }
        .logo { font-size: 22px; font-weight: 800; margin-bottom: 40px; color: #fff; display: flex; align-items: center; gap: 10px; }
        .logo i { color: var(--primary-color); font-size: 26px; }
        .menu-item { height: 48px; padding: 0 16px; cursor: pointer; border-radius: 14px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; color: var(--text-secondary); transition: 0.2s; font-size: 16px; font-weight: 500; }
        .menu-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .menu-item.active { background: rgba(62, 123, 255, 0.15); color: var(--primary-color); }
        .badge { background: rgba(255,255,255,0.1); color: #fff; padding: 3px 9px; border-radius: 99px; font-size: 12px; font-weight: 700; opacity: 0; transition: opacity 0.2s; }

        /* MAIN AREA */
        .main { flex: 1; padding: 48px; overflow-y: auto; max-width: 900px; margin: 0 auto; box-sizing: border-box; position: relative; z-index: 5; }
        .header { margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; }
        .title { font-size: 32px; font-weight: 800; color: #fff; letter-spacing: -0.5px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        
        /* –ö–ù–û–ü–ö–ò */
        .btn-add { 
            background: var(--primary-color); color: white; width: 48px; height: 48px; 
            border-radius: 16px; border: none; font-size: 28px; cursor: pointer; 
            box-shadow: 0 8px 16px rgba(62, 123, 255, 0.3); transition: 0.3s;
            display: flex; justify-content: center; align-items: center; padding: 0; flex-shrink: 0;
            position: relative; z-index: 100;
        }
        .btn-add:active { transform: scale(0.95); }

        .btn-mic {
            background: rgba(255,255,255,0.1); color: white; width: 48px; height: 48px;
            border-radius: 16px; border: none; font-size: 24px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: 0.2s; flex-shrink: 0;
            position: relative; z-index: 90;
        }
        .btn-mic.listening { background: #EF4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .btn-wizard {
            width: 100%; background: rgba(62, 123, 255, 0.1); color: var(--primary-color);
            border: 1px solid rgba(62, 123, 255, 0.3); border-radius: 16px; padding: 16px;
            font-size: 16px; font-weight: 700; display: flex; justify-content: center; align-items: center; gap: 10px;
            cursor: pointer; margin-bottom: 24px; transition: 0.2s; backdrop-filter: blur(5px);
        }

        /* --- TASK CARD --- */
        .task-list { display: flex; flex-direction: column; gap: 14px; position: relative; z-index: 2; }
        
        .task-card { 
            background: var(--card-bg); padding: 16px; border-radius: var(--radius-xl); 
            border: 1px solid var(--border-color); backdrop-filter: var(--glass-blur);
            display: flex; flex-direction: column; gap: 12px; transition: 0.2s;
        }
        
        .task-top-row { display: flex; align-items: flex-start; gap: 14px; width: 100%; }
        
        .task-check { 
            width: 26px; height: 26px; border: 2px solid rgba(255,255,255,0.2); 
            border-radius: 9px; transition: 0.2s; flex-shrink: 0; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; margin-top: 2px; 
        }
        .task-check.checked { background: var(--success); border-color: var(--success); color: white; }
        
        .task-title { 
            font-size: 17px; font-weight: 600; color: #fff; line-height: 1.5; 
            word-break: break-word; flex: 1;
        }

        .task-bottom-row {
            display: flex; justify-content: space-between; align-items: center; 
            width: 100%; gap: 10px; flex-wrap: wrap; 
        }

        .task-meta { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .actions { display: flex; gap: 8px; opacity: 1; align-items: center; margin-left: auto; }
        
        .btn-action { 
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.05);
            color: #ccc; width: 38px; height: 38px; border-radius: 12px; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; 
        }
        .btn-action:hover { background: rgba(255,255,255,0.2); color: #fff; }
        .btn-action i { font-size: 20px; }
        .btn-action.ai-magic { background: linear-gradient(135deg, #a855f7, #ec4899); border: none; color: white; box-shadow: 0 4px 10px rgba(168, 85, 247, 0.3); }

        .task-card.quick-task {
            border: 1px solid rgba(250, 204, 21, 0.3);
            background: linear-gradient(90deg, rgba(250, 204, 21, 0.05) 0%, rgba(255,255,255,0.02) 100%);
        }

        .tag.quick { background: linear-gradient(90deg, #FACC15, #EAB308); color: #000 !important; font-weight: 800; padding: 4px 10px; box-shadow: 0 0 15px rgba(250, 204, 21, 0.4); border-radius: 8px; display:inline-flex; align-items:center; gap:4px; }
        .tag { padding: 4px 10px; background: rgba(255,255,255,0.1); color: var(--text-secondary); border-radius: 8px; font-size: 11px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .tag.context-tag { color: #60A5FA; background: rgba(96, 165, 250, 0.1); }

        /* EMPTY STATE */
        .empty-state-container { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; position: relative; z-index: 2; }
        .empty-card {
            background: rgba(30, 30, 35, 0.6); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px; padding: 20px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: 0.2s; backdrop-filter: blur(10px);
        }
        .empty-card:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.1); }
        .empty-icon-box { width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        .empty-text strong { display: block; font-size: 16px; color: #fff; margin-bottom: 2px; }
        .empty-text span { font-size: 13px; color: var(--text-secondary); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: #1C1E26; width: 450px; max-width: 90%; padding: 32px; border-radius: 32px; border: 1px solid var(--border-color); display: flex; flex-direction: column; max-height: 85vh; box-shadow: 0 20px 50px rgba(0,0,0,0.7); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; font-size: 22px; font-weight: 800; margin-bottom: 24px; color: #fff; }
        .btn-primary { 
            background: var(--primary-color); color: white; height: 56px; 
            border-radius: 18px; border: none; font-weight: 700; font-size: 16px; width: 100%;
            box-shadow: 0 8px 16px rgba(62, 123, 255, 0.2); cursor: pointer;
        }
        
        .step-row { 
            display: flex; align-items: center; gap: 10px; 
            background: #0f1014; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω */
            padding: 14px; border-radius: 14px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.1);
        }
        .step-row input { 
            background: transparent !important; border: none !important; 
            font-size: 16px; color: #FFFFFF !important; font-weight: 600; opacity: 1;
        }

        /* WIZARD & FOCUS STYLES */
        .wizard-visual { display: flex; justify-content: center; margin-bottom: 24px; }
        .wizard-icon-circle {
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(62, 123, 255, 0.1); border: 2px solid rgba(62, 123, 255, 0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: var(--primary-color);
            box-shadow: 0 0 30px rgba(62, 123, 255, 0.2);
        }
        .wizard-buttons { display: flex; flex-direction: column; gap: 12px; width: 100%; margin-bottom: 10px; }
        .wizard-btn { 
            width: 100%; padding: 18px; border-radius: 18px; border: 1px solid; 
            background: rgba(255,255,255,0.03); color: white; font-size: 17px; 
            font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; 
            justify-content: center; align-items: center;
        }
        .wizard-btn:active { transform: scale(0.98); }

        .focus-item { 
            background: rgba(250, 204, 21, 0.1); border: 1px solid rgba(250, 204, 21, 0.3);
            padding: 16px; border-radius: 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 12px;
        }
        .focus-num { font-size: 18px; font-weight: 800; color: #FACC15; }
        .focus-text { font-size: 16px; font-weight: 600; color: #fff; }
        
        /* REVIEW MODAL TEXT */
        .review-text-content {
            white-space: pre-wrap; color: #e2e8f0; line-height: 1.6; font-size: 15px; 
            background: rgba(255,255,255,0.03); padding: 16px; border-radius: 16px;
            max-height: 400px; overflow-y: auto;
        }

        .premium-status { padding: 20px; border-radius: 20px; margin-bottom: 24px; font-size: 15px; line-height: 1.5; border: 1px solid transparent; }
        .premium-status.active { background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3); color: #4ade80; }
        .premium-status.expired { background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); color: var(--text-secondary); }

        .bottom-nav { display: none; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { padding: 20px; padding-bottom: 120px; overflow-y: auto; height: 100%; }
            .title { font-size: 28px; }
            .header { margin-bottom: 24px; }
            .bottom-nav { 
                position: fixed; bottom: 20px; left: 16px; right: 16px; 
                background: rgba(30, 32, 40, 0.9); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
                padding: 10px 12px; border-radius: 32px; border: 1px solid rgba(255, 255, 255, 0.08); 
                z-index: 1000; overflow-x: auto; white-space: nowrap; display: flex; align-items: center; gap: 6px;
                scrollbar-width: none; -ms-overflow-style: none; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            }
            .bottom-nav::-webkit-scrollbar { display: none; }
            .nav-item { 
                display: inline-flex; flex-direction: column; align-items: center; justify-content: center; 
                min-width: 70px; padding: 6px 4px; color: #94A3B8; font-size: 11px; font-weight: 600; 
                border-radius: 20px; transition: all 0.3s ease; position: relative; flex-shrink: 0;
            }
            .nav-item.active { color: #FFFFFF; background: rgba(255, 255, 255, 0.12); }
            .nav-icon { font-size: 24px; margin-bottom: 3px; position: relative; display: flex; align-items: center; justify-content: center; }
            .nav-badge { 
                position: absolute; top: -4px; right: -6px; background: var(--primary-color); color: white; 
                font-size: 10px; font-weight: 800; min-width: 16px; height: 16px; border-radius: 10px; 
                display: flex; align-items: center; justify-content: center; padding: 0 3px; border: 2px solid #1e2028; 
                display: none; 
            }
        }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>

    <div id="splash-screen">
        <canvas id="splash-canvas"></canvas>
        <div class="splash-content">
            <div style="font-size: 56px; color: var(--primary-color); margin-bottom: 24px; text-shadow: 0 0 30px rgba(62,123,255,0.5);"><i class="ph-fill ph-brain"></i></div>
            <div class="quote-text" id="splash-quote"></div>
            <div class="quote-author" id="splash-author"></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo"><i class="ph-fill ph-brain"></i> Focus AI 3.6</div>
        <div class="menu-item active" onclick="switchView('inbox')"><span><i class="ph ph-tray"></i> Inbox</span><span class="badge" id="badge-inbox">0</span></div>
        <div class="menu-item" onclick="switchView('today')"><span><i class="ph ph-fire"></i> –°–µ–≥–æ–¥–Ω—è</span><span class="badge" id="badge-today">0</span></div>
        <div class="menu-item" onclick="switchView('projects')"><span><i class="ph ph-kanban"></i> –ü—Ä–æ–µ–∫—Ç—ã</span><span class="badge" id="badge-projects">0</span></div>
        <div class="spacer" style="height:20px;"></div>
        <div class="menu-item" onclick="switchView('calendar')"><span><i class="ph ph-calendar-blank"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å</span><span class="badge" id="badge-calendar">0</span></div>
        <div class="menu-item" onclick="switchView('waiting')"><span><i class="ph ph-clock-user"></i> –ü–æ—Ä—É—á–µ–Ω–∏—è</span><span class="badge" id="badge-waiting">0</span></div>
        <div class="menu-item" onclick="switchView('someday')"><span><i class="ph ph-lightbulb"></i> –ü–æ—Ç–æ–º</span><span class="badge" id="badge-someday">0</span></div>
        <div class="menu-item" onclick="switchView('reference')"><span><i class="ph ph-archive-box"></i> –ê—Ä—Ö–∏–≤</span><span class="badge" id="badge-reference">0</span></div>
        <div class="spacer" style="height:20px;"></div>
        <div class="menu-item" onclick="switchView('done')"><span><i class="ph ph-check-circle"></i> –ì–æ—Ç–æ–≤–æ</span><span class="badge" id="badge-done">0</span></div>
        <div class="menu-item" onclick="switchView('trash')"><span><i class="ph ph-trash"></i> –ö–æ—Ä–∑–∏–Ω–∞</span><span class="badge" id="badge-trash">0</span></div>
        <div class="spacer" style="flex:1;"></div>
        <div class="menu-item" onclick="openSettings()"><span style="color:var(--text-main)"><i class="ph ph-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</span></div>
    </div>

    <div class="main"><div id="app-view"></div></div>

    <nav class="bottom-nav" id="bottom-nav-container">
        <div style="width: 10px; flex-shrink: 0;"></div>
        <div class="nav-item active" onclick="switchView('inbox')"><div class="nav-icon"><i class="ph ph-tray"></i><div class="nav-badge" id="mob-badge-inbox">0</div></div>Inbox</div>
        <div class="nav-item" onclick="switchView('today')"><div class="nav-icon"><i class="ph ph-fire"></i><div class="nav-badge" id="mob-badge-today">0</div></div>–°–µ–≥–æ–¥–Ω—è</div>
        <div class="nav-item" onclick="switchView('projects')"><div class="nav-icon"><i class="ph ph-kanban"></i><div class="nav-badge" id="mob-badge-projects">0</div></div>–ü—Ä–æ–µ–∫—Ç—ã</div>
        <div class="nav-item" onclick="switchView('calendar')"><div class="nav-icon"><i class="ph ph-calendar-blank"></i><div class="nav-badge" id="mob-badge-calendar">0</div></div>–ö–∞–ª–µ–Ω–¥.</div>
        <div class="nav-item" onclick="switchView('waiting')"><div class="nav-icon"><i class="ph ph-clock-user"></i><div class="nav-badge" id="mob-badge-waiting">0</div></div>–ü–æ—Ä—É—á.</div>
        <div class="nav-item" onclick="switchView('someday')"><div class="nav-icon"><i class="ph ph-lightbulb"></i><div class="nav-badge" id="mob-badge-someday">0</div></div>–ü–æ—Ç–æ–º</div>
        <div class="nav-item" onclick="switchView('reference')"><div class="nav-icon"><i class="ph ph-archive-box"></i><div class="nav-badge" id="mob-badge-reference">0</div></div>–ê—Ä—Ö–∏–≤</div>
        <div class="nav-item" onclick="switchView('done')"><div class="nav-icon"><i class="ph ph-check-circle"></i><div class="nav-badge" id="mob-badge-done">0</div></div>–ì–æ—Ç–æ–≤–æ</div>
        <div class="nav-item" onclick="switchView('trash')"><div class="nav-icon"><i class="ph ph-trash"></i><div class="nav-badge" id="mob-badge-trash">0</div></div>–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div class="nav-item" onclick="openSettings()"><div class="nav-icon"><i class="ph ph-gear"></i></div>–ú–µ–Ω—é</div>
        <div style="width: 10px; flex-shrink: 0;"></div>
    </nav>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏<i class="ph ph-x close-btn" onclick="closeModal('settings-modal')" style="cursor:pointer"></i></div>
            <div id="premium-status-box" class="premium-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <div id="ai-review-btn-container" style="display:none; margin-bottom:20px;">
                <label style="display:block; font-size:12px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">AI –§–£–ù–ö–¶–ò–ò</label>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <button id="btn-week-review" class="btn-primary" style="background: linear-gradient(135deg, #10B981, #059669); font-size:14px; flex:1;" onclick="generateWeeklyReview()"><i class="ph-bold ph-chart-line-up"></i> Weekly Review</button>
                    <button id="btn-auto-tag" class="btn-primary" style="background: linear-gradient(135deg, #3B82F6, #2563EB); font-size:14px; flex:1;" onclick="retroactiveTagging()"><i class="ph-bold ph-tag"></i> –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–≥–∏ (AI)</button>
                </div>
            </div>
            <label style="display:block; font-size:12px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–ü–†–û–ú–û–ö–û–î</label>
            <div style="display:flex; gap:8px; margin-bottom:24px;">
                <input type="text" id="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" style="text-transform:uppercase;">
                <button class="btn-primary" style="width:auto; padding:0 24px;" onclick="activatePromo()">OK</button>
            </div>
            <label style="display:block; font-size:12px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–û–ë–†–ê–¢–ù–ê–Ø –°–í–Ø–ó–¨</label>
            <textarea id="feedback-text" placeholder="–í–∞—à–∏ –∏–¥–µ–∏..." onfocus="this.scrollIntoView({behavior: 'smooth', block: 'center'})" style="width:100%; box-sizing:border-box; height:80px; margin-bottom:12px; resize:none;"></textarea>
            <button class="btn-primary" style="background:#334155;" onclick="sendFeedback()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            <div style="text-align:center; margin-top:20px; font-size:11px; color:var(--text-secondary);">
                FocusSystem v2.0 ‚Ä¢ beta "AI Edition" <br><span id="debug-id" style="font-size: 9px; opacity: 0.5;"></span>
            </div>
        </div>
    </div>

    <div id="search-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">üîç –ü–æ–∏—Å–∫<i class="ph ph-x close-btn" onclick="closeModal('search-modal')" style="cursor:pointer"></i></div>
            <div style="display:flex; gap:8px; margin-bottom:20px;">
                <input type="text" id="search-input" placeholder="–ù–∞–π—Ç–∏ –∑–∞–¥–∞—á—É..." style="flex:1;" oninput="performSearch()">
                <button class="btn-primary" style="width:auto; padding:0 20px;" onclick="performSearch()"><i class="ph-bold ph-magnifying-glass"></i></button>
            </div>
            <div id="search-results" style="overflow-y:auto; flex:1; display:flex; flex-direction:column; gap:10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 12px; min-height: 100px;">
                <div style="text-align:center; color:var(--text-secondary); font-size:14px;">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞...</div>
            </div>
        </div>
    </div>
    
    <div id="review-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">üìä Weekly Review<i class="ph ph-x close-btn" onclick="closeModal('review-modal')" style="cursor:pointer"></i></div>
            <div id="review-content" class="review-text-content"></div>
            <button class="btn-primary" style="margin-top:24px;" onclick="closeModal('review-modal')">–û—Ç–ª–∏—á–Ω–æ</button>
        </div>
    </div>

    <div id="project-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><span id="proj-modal-title">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</span><i class="ph ph-x close-btn" onclick="closeModal('project-modal')"></i></div>
            <div style="overflow-y:auto; flex:1;"> 
                <input type="hidden" id="proj-edit-id"> 
                <label style="display:block; font-size:12px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–ù–ê–ó–í–ê–ù–ò–ï</label>
                <input type="text" id="proj-name" style="width:100%; box-sizing:border-box; margin-bottom:20px;" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–¥–µ–ª–∞—Ç—å —Ä–µ–º–æ–Ω—Ç">
                <label style="display:block; font-size:12px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–†–ï–ó–£–õ–¨–¢–ê–¢ (–¶–ï–õ–¨)</label>
                <input type="text" id="proj-goal" placeholder="–ö–∞–∫ –ø–æ–π–º–µ—à—å, —á—Ç–æ –≥–æ—Ç–æ–≤–æ?" style="width:100%; box-sizing:border-box; margin-bottom:24px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <label style="font-size:12px; font-weight:800; color:var(--text-secondary);">–ü–ï–†–í–´–ï –®–ê–ì–ò</label>
                    <button id="btn-ai-magic" onclick="askAIForSteps()" style="border:none; background: linear-gradient(135deg, #a855f7, #ec4899); color:white; font-size:12px; font-weight:700; padding:8px 16px; border-radius:10px; cursor:pointer; display:none; box-shadow:0 4px 15px rgba(168, 85, 247, 0.4);">
                        <i class="ph-bold ph-magic-wand"></i> –ê–≤—Ç–æ-–ø–ª–∞–Ω (AI)
                    </button>
                </div>
                <div id="proj-steps-container" style="margin-bottom: 12px;"></div>
                <div style="display:flex; gap:12px; margin-bottom:24px;">
                    <input type="text" id="proj-new-step" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥..." style="flex:1;">
                    <button class="btn-primary" style="width:60px;" onclick="addStepToUI()"><i class="ph ph-plus"></i></button>
                </div>
            </div>
            <button class="btn-primary" onclick="saveProject()" style="margin-top:20px; flex-shrink:0;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        </div>
    </div>
    
    <div id="wizard-modal" class="modal-overlay">
        <div class="modal" style="text-align:center;">
            <div style="font-size:12px; text-transform:uppercase; color:var(--text-secondary); margin-bottom:20px; font-weight: 800; letter-spacing:1px;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ Inbox</div>
            <div class="wizard-visual"><div class="wizard-icon-circle"><i id="wizard-icon" class="ph-fill ph-question"></i></div></div>
            <div style="margin-bottom: 24px;"><strong id="wizard-task-text" style="font-size: 20px; line-height: 1.4; color:#fff;">...</strong></div>
            <div id="wizard-question-text" style="font-size:18px; font-weight:600; margin-bottom:32px; color:var(--primary-color);">...</div>
            <div class="wizard-buttons">
                <button class="wizard-btn" style="background:rgba(255,77,77,0.1); color:#FF4D4D; border-color:rgba(255,77,77,0.3);" onclick="handleWizardAnswer(false)" id="btn-no">–ù–µ—Ç</button>
                <button class="wizard-btn" style="background:rgba(34,197,94,0.1); color:#22C55E; border-color:rgba(34,197,94,0.3);" onclick="handleWizardAnswer(true)" id="btn-yes">–î–∞</button>
            </div>
            <button onclick="closeModal('wizard-modal')" style="width:100%; margin-top:20px; border:none; background:none; color:var(--text-secondary); font-size:15px; padding: 10px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <div id="focus-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">‚ö°Ô∏è AI ULTRA FOCUS<i class="ph ph-x close-btn" onclick="closeModal('focus-modal')" style="cursor:pointer"></i></div>
            <div style="margin-bottom:20px; color:var(--text-secondary); text-align:center;">–°–∏—Å—Ç–µ–º–∞ –≤—ã–±—Ä–∞–ª–∞ 3 –∑–∞–¥–∞—á–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.</div>
            <div id="focus-list-container"></div>
            <button class="btn-primary" style="margin-top:24px; background:linear-gradient(135deg, #FACC15, #EAB308); color:black;" onclick="closeModal('focus-modal')">üöÄ –ü—Ä–∏–Ω—è—Ç–æ, —Ä–∞–±–æ—Ç–∞—é!</button>
        </div>
    </div>

    <div id="input-modal" class="modal-overlay"><div class="modal"><div class="modal-header" id="input-modal-title">–í–≤–æ–¥</div><input type="text" id="input-modal-field" style="width: 100%; box-sizing:border-box; margin-bottom: 24px;"><button class="btn-primary" onclick="submitInputModal()">–û–ö</button></div></div>
    <div id="date-modal" class="modal-overlay"><div class="modal"><div class="modal-header">üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</div><label style="font-size:12px; font-weight:700; color:var(--text-secondary); margin-bottom:4px; display:block;">–î–ê–¢–ê</label><input type="date" id="calendar-date" style="width:100%; box-sizing:border-box; margin-bottom:16px;"><label style="font-size:12px; font-weight:700; color:var(--text-secondary); margin-bottom:4px; display:block;">–í–†–ï–ú–Ø</label><input type="time" id="calendar-time" style="width:100%; box-sizing:border-box; margin-bottom:24px;"><button class="btn-primary" onclick="submitDateModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>
    <div id="move-modal" class="modal-overlay"><div class="modal"><div class="modal-header">–ö—É–¥–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å?</div><div style="display:flex; flex-direction:column; gap:8px; overflow-y:auto; max-height: 400px;"><button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('inbox')"><span><i class="ph ph-tray"></i> Inbox</span></button><button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('today')"><span><i class="ph ph-fire"></i> –°–µ–≥–æ–¥–Ω—è</span></button><button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('calendar')"><span><i class="ph ph-calendar-blank"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button><button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('waiting')"><span><i class="ph ph-clock-user"></i> –ü–æ—Ä—É—á–µ–Ω–∏—è</span></button><button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('someday')"><span><i class="ph ph-lightbulb"></i> –ü–æ—Ç–æ–º</span></button><button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('reference')"><span><i class="ph ph-archive-box"></i> –ê—Ä—Ö–∏–≤</span></button></div><button onclick="closeModal('move-modal')" style="width:100%; margin-top:20px; border:none; background:none; color:var(--text-secondary); font-size:15px; padding: 10px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const API_URL = 'https://636a13eb-9e28-4f04-a3b6-37318d504198-00-1eel6lm7asdp7.janeway.replit.dev'; 
        const firebaseConfig = { apiKey: "AIzaSyALuLfaVgYjc3rHXJz9g8TMJpO9Lzryfj4", authDomain: "gtd-focus-app.firebaseapp.com", databaseURL: "https://gtd-focus-app-default-rtdb.firebaseio.com", projectId: "gtd-focus-app", storageBucket: "gtd-focus-app.firebasestorage.app", messagingSenderId: "54533448500", appId: "1:54533448500:web:0c59c28d63ce03af1abb61", measurementId: "G-D0PNMT824K" };

        const app = initializeApp(firebaseConfig);
        const dbRef = getDatabase(app);
        const auth = getAuth(app); 
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let db = { inbox: [], today: [], calendar: [], projects: [], waiting: [], someday: [], reference: [], done: [], trash: [], premiumUntil: null };
        let currentView = 'inbox';
        let currentUserID = 'guest_user';
        let isLoaded = false; 

        window.closeApp = function() { if(tg) tg.close(); }

        /* --- 30 QUOTES --- */
        const QUOTES = [
            { t: "–°–µ–∫—Ä–µ—Ç —É—Å–ø–µ—Ö–∞ ‚Äî –Ω–∞—á–∞—Ç—å.", a: "–ú–∞—Ä–∫ –¢–≤–µ–Ω" }, { t: "–î–µ–ª–∞–π —Ç–æ, —á—Ç–æ –º–æ–∂–µ—à—å, —Å —Ç–µ–º, —á—Ç–æ –∏–º–µ–µ—à—å.", a: "–¢. –†—É–∑–≤–µ–ª—å—Ç" },
            { t: "–ó–∞–Ω—è—Ç–æ—Å—Ç—å –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.", a: "–¢–∏–º –§–µ—Ä—Ä–∏—Å" }, { t: "–¢–≤–æ–π –º–æ–∑–≥ ‚Äî –¥–ª—è –∏–¥–µ–π, –∞ –Ω–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è.", a: "–î—ç–≤–∏–¥ –ê–ª–ª–µ–Ω" },
            { t: "–§–æ–∫—É—Å ‚Äî —ç—Ç–æ —Å–∫–∞–∑–∞—Ç—å '–Ω–µ—Ç'.", a: "–°—Ç–∏–≤ –î–∂–æ–±—Å" }, { t: "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Äî —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –¥–µ–ª–∞—Ç—å —Ç–æ, —á–µ–≥–æ –Ω–µ —Ö–æ—á–µ—Ç—Å—è.", a: "–ú–∞–π–∫ –¢–∞–π—Å–æ–Ω" },
            { t: "–ë—É–¥—É—â–µ–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ —Å–µ–≥–æ–¥–Ω—è.", a: "–ú–∞—Ö–∞—Ç–º–∞ –ì–∞–Ω–¥–∏" }, { t: "–ü–ª–∞–Ω—ã –Ω–∏—á—Ç–æ, –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –≤—Å—ë.", a: "–î. –≠–π–∑–µ–Ω—Ö–∞—É—ç—Ä" },
            { t: "–ü—Ä–æ—Å—Ç–æ—Ç–∞ ‚Äî –≤—ã—Å—à–∞—è —Å—Ç—É–ø–µ–Ω—å —É—Ç–æ–Ω—á–µ–Ω–Ω–æ—Å—Ç–∏.", a: "–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏" }, { t: "–ù–µ –∂–¥–∏—Ç–µ. –í—Ä–µ–º—è –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—É–¥–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–º.", a: "–ù–∞–ø–æ–ª–µ–æ–Ω –•–∏–ª–ª" },
            { t: "–£—Å–ø–µ—Ö ‚Äî —ç—Ç–æ —Å—É–º–º–∞ –Ω–µ–±–æ–ª—å—à–∏—Ö —É—Å–∏–ª–∏–π, –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∏–∑–æ –¥–Ω—è –≤ –¥–µ–Ω—å.", a: "–†–æ–±–µ—Ä—Ç –ö–æ–ª—å–µ—Ä" }, { t: "–õ—é–±–∏—Ç–µ–ª—å –∂–¥–µ—Ç –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏—è, –ø—Ä–æ—Ñ–∏ –≤—Å—Ç–∞–µ—Ç –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç.", a: "–°—Ç–∏–≤–µ–Ω –ö–∏–Ω–≥" },
            { t: "–í–∞—à–µ –≤—Ä–µ–º—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ, –Ω–µ –∂–∏–≤–∏—Ç–µ —á—É–∂–æ–π –∂–∏–∑–Ω—å—é.", a: "–°—Ç–∏–≤ –î–∂–æ–±—Å" }, { t: "–î–µ–π—Å—Ç–≤–∏–µ ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É.", a: "–ü–∞–±–ª–æ –ü–∏–∫–∞—Å—Å–æ" },
            { t: "–ö–∞–∂–¥–∞—è –º–∏–Ω—É—Ç–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —ç–∫–æ–Ω–æ–º–∏—Ç —á–∞—Å.", a: "–ë. –§—Ä–∞–Ω–∫–ª–∏–Ω" }, { t: "–ö—Ç–æ —Ö–æ—á–µ—Ç ‚Äî –∏—â–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –∫—Ç–æ –Ω–µ —Ö–æ—á–µ—Ç ‚Äî –ø—Ä–∏—á–∏–Ω—ã.", a: "–°–æ–∫—Ä–∞—Ç" },
            { t: "–ù–µ –±–æ–π—Ç–µ—Å—å —Ä–∞—Å—Ç–∏ –º–µ–¥–ª–µ–Ω–Ω–æ, –±–æ–π—Ç–µ—Å—å —Å—Ç–æ—è—Ç—å –Ω–∞ –º–µ—Å—Ç–µ.", a: "–ö–∏—Ç–∞–π—Å–∫–∞—è –º—É–¥—Ä–æ—Å—Ç—å" }, { t: "–°–∞–º—ã–π —Ç—Ä—É–¥–Ω—ã–π —à–∞–≥ ‚Äî —ç—Ç–æ —à–∞–≥ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –ø—Ä–∏–≤—ã—á–Ω–æ–≥–æ.", a: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π" },
            { t: "–ï—Å–ª–∏ –≤—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ —á–µ—Ä–µ–∑ –∞–¥, –∏–¥–∏—Ç–µ –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è—Å—å.", a: "–£. –ß–µ—Ä—á–∏–ª–ª—å" }, { t: "–í—á–µ—Ä–∞ ‚Äî –∏—Å—Ç–æ—Ä–∏—è, –∑–∞–≤—Ç—Ä–∞ ‚Äî —Ç–∞–π–Ω–∞, —Å–µ–≥–æ–¥–Ω—è ‚Äî –ø–æ–¥–∞—Ä–æ–∫.", a: "–ö—É–Ω–≥-—Ñ—É –ü–∞–Ω–¥–∞" },
            { t: "–ß—Ç–æ–±—ã –¥–æ–π—Ç–∏ –¥–æ —Ü–µ–ª–∏, –Ω–∞–¥–æ –ø—Ä–µ–∂–¥–µ –≤—Å–µ–≥–æ –∏–¥—Ç–∏.", a: "–û–Ω–æ—Ä–µ –¥–µ –ë–∞–ª—å–∑–∞–∫" }, { t: "–ù–µ—É–¥–∞—á–∞ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—á–∞—Ç—å —Å–Ω–æ–≤–∞, –Ω–æ –º—É–¥—Ä–µ–µ.", a: "–ì–µ–Ω—Ä–∏ –§–æ—Ä–¥" },
            { t: "–ù–∞—á–∏–Ω–∞–π —Ç–∞–º, –≥–¥–µ —Ç—ã –µ—Å—Ç—å.", a: "–ê—Ä—Ç—É—Ä –≠—à" }, { t: "–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å –±—É–¥—É—â–µ–µ ‚Äî —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ.", a: "–ü–∏—Ç–µ—Ä –î—Ä—É–∫–µ—Ä" },
            { t: "–ü–æ—Ä—è–¥–æ–∫ –≤ –≤–µ—â–∞—Ö ‚Äî –ø–æ—Ä—è–¥–æ–∫ –≤ –º—ã—Å–ª—è—Ö.", a: "–ù–∞—Ä–æ–¥–Ω–∞—è –º—É–¥—Ä–æ—Å—Ç—å" }, { t: "–ú–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ –≤–µ–¥—É—Ç –∫ –±–æ–ª—å—à–∏–º –ø–µ—Ä–µ–º–µ–Ω–∞–º.", a: "–ö–∞–π–¥–∑–µ–Ω" },
            { t: "–£–º–Ω—ã–π —á–µ–ª–æ–≤–µ–∫ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã, –º—É–¥—Ä—ã–π –∏—Ö –∏–∑–±–µ–≥–∞–µ—Ç.", a: "–≠–π–Ω—à—Ç–µ–π–Ω" }, { t: "–°–¥–µ–ª–∞–Ω–Ω–æ–µ –ª—É—á—à–µ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ.", a: "Facebook Motto" },
            { t: "–í—Ä–µ–º—è ‚Äî —Å–∞–º—ã–π —Ü–µ–Ω–Ω—ã–π —Ä–µ—Å—É—Ä—Å.", a: "–¢–µ–æ—Ñ—Ä–∞—Å—Ç" }, { t: "–ñ–∏–≤–∏ —Ç–∞–∫, –±—É–¥—Ç–æ —ç—Ç–æ—Ç –¥–µ–Ω—å ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–π.", a: "–°–µ–Ω–µ–∫–∞" }
        ];

        /* --- 3D GEOMETRY ENGINE --- */
        class Geometry3D {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.vertices = []; this.edges = [];
                this.angleX = 0; this.angleY = 0;
                this.resize(); this.initIcosahedron();
                window.addEventListener('resize', () => this.resize());
            }
            resize() { this.canvas.width = window.innerWidth; this.canvas.height = window.innerHeight; this.cx = this.canvas.width/2; this.cy = this.canvas.height/2; }
            initIcosahedron() {
                const t = (1.0 + Math.sqrt(5.0)) / 2.0;
                this.vertices = [[-1,t,0],[1,t,0],[-1,-t,0],[1,-t,0],[0,-1,t],[0,1,t],[0,-1,-t],[0,1,-t],[t,0,-1],[t,0,1],[-t,0,-1],[-t,0,1]];
                for(let i=0; i<this.vertices.length; i++) for(let j=i+1; j<this.vertices.length; j++) if(Math.hypot(this.vertices[i][0]-this.vertices[j][0], this.vertices[i][1]-this.vertices[j][1], this.vertices[i][2]-this.vertices[j][2]) < 2.5) this.edges.push([i, j]);
            }
            rotate(v, ax, ay) {
                let y = v[1], z = v[2]; v[1] = y*Math.cos(ax) - z*Math.sin(ax); v[2] = z*Math.cos(ax) + y*Math.sin(ax);
                let x = v[0]; z = v[2]; v[0] = x*Math.cos(ay) - z*Math.sin(ay); v[2] = z*Math.cos(ay) + x*Math.sin(ay);
            }
            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.angleX += 0.005; this.angleY += 0.008;
                const scale = Math.min(this.canvas.width, this.canvas.height) * 0.25;
                const projected = [];
                const time = Date.now() * 0.001;
                this.vertices.forEach((v, i) => {
                    const pulse = 1 + Math.sin(time + i) * 0.1;
                    let rotV = [v[0]*pulse, v[1]*pulse, v[2]*pulse];
                    this.rotate(rotV, this.angleX, this.angleY);
                    projected.push({ x: this.cx + rotV[0]*scale, y: this.cy + rotV[1]*scale, z: rotV[2] });
                });
                this.edges.forEach(e => {
                    const p1 = projected[e[0]], p2 = projected[e[1]];
                    const alpha = ((p1.z + p2.z)/2 + 2) / 4;
                    this.ctx.beginPath(); this.ctx.moveTo(p1.x, p1.y); this.ctx.lineTo(p2.x, p2.y);
                    this.ctx.strokeStyle = `hsla(${(time*20)%360}, 70%, 60%, ${alpha})`; this.ctx.stroke();
                });
                projected.forEach(p => {
                    this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
                    this.ctx.fillStyle = `rgba(255,255,255,0.8)`; this.ctx.fill();
                });
                requestAnimationFrame(() => this.animate());
            }
        }

        let bgGeo, splashGeo;
        function initSplash() {
            splashGeo = new Geometry3D('splash-canvas'); splashGeo.animate();
            bgGeo = new Geometry3D('bg-canvas'); bgGeo.animate();
            const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
            document.getElementById('splash-quote').innerText = `"${q.t}"`;
            document.getElementById('splash-author').innerText = `‚Äî ${q.a}`;
            setTimeout(() => { document.getElementById('splash-screen').style.display = 'none'; }, 2700);
        }

        /* --- SCROLL FOR PC --- */
        const scrollContainer = document.getElementById("bottom-nav-container");
        if(scrollContainer) {
            scrollContainer.addEventListener("wheel", (evt) => {
                evt.preventDefault();
                scrollContainer.scrollLeft += evt.deltaY;
            });
        }

        /* --- AUTH & DB --- */
        async function initUserInfo() {
            const user = tg.initDataUnsafe?.user;
            if (user) {
                currentUserID = String(user.id);
                document.querySelector('.logo').innerHTML = `<i class="ph-fill ph-brain"></i> ${user.first_name}'s Focus`;
                try {
                    const response = await fetch(`${API_URL}/api/auth`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ initData: tg.initData }) });
                    if (response.ok) { const data = await response.json(); if (data.token) await signInWithCustomToken(auth, data.token); }
                } catch (e) { console.error(e); }
            } else {
                let storedId = localStorage.getItem('gtd_guest_id');
                if(!storedId) { storedId = 'web_' + Date.now(); localStorage.setItem('gtd_guest_id', storedId); }
                currentUserID = storedId;
            }
            let userPathId = auth.currentUser?.uid || currentUserID;
            onValue(ref(dbRef, 'users/' + userPathId), (snapshot) => {
                const data = snapshot.val();
                if (data) { db = { ...db, ...data }; ['inbox','today','projects','waiting','done','trash'].forEach(k => { if(!Array.isArray(db[k])) db[k] = Object.values(db[k] || {}); }); } 
                isLoaded = true; updateBadges(); renderCurrentView();
                if(document.getElementById('debug-id')) document.getElementById('debug-id').innerText = 'ID: ' + userPathId;
                
                // Hide mic on iPhone
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const micBtn = document.getElementById('btn-mic');
                if(isIOS && micBtn) micBtn.style.display = 'none';
            });
        }
        function saveDB() {
            if (!isLoaded) return;
            const dataToSave = { inbox: db.inbox||[], today: db.today||[], calendar: db.calendar||[], projects: db.projects||[], waiting: db.waiting||[], someday: db.someday||[], reference: db.reference||[], done: db.done||[], trash: db.trash||[] };
            update(ref(dbRef, 'users/' + (auth.currentUser?.uid || currentUserID)), dataToSave);
            updateBadges(); renderCurrentView();
        }

        window.updateBadges = function() {
            const keys = ['inbox', 'today', 'projects', 'calendar', 'waiting', 'someday', 'reference', 'done', 'trash'];
            keys.forEach(k => {
                const count = (db[k] || []).length;
                const el = document.getElementById(`badge-${k}`);
                const mobEl = document.getElementById(`mob-badge-${k}`);
                
                if(el) { 
                    el.innerText = count; 
                    el.style.opacity = count > 0 ? 1 : 0; 
                }
                if(mobEl) { 
                    mobEl.innerText = count; 
                    mobEl.style.display = count > 0 ? 'flex' : 'none'; 
                }
            });
        }

        /* --- LOGIC UTILS --- */
        function checkPremiumLimits() {
            if ((db.premiumUntil && new Date(db.premiumUntil) > new Date()) || (db.isPremium === true && !db.premiumUntil)) return true;
            if ((db.projects || []).filter(p => !p.completedAt).length >= 3) { alert("üíé –õ–∏–º–∏—Ç! –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≤–µ—Ä—Å–∏—è: 3 –ø—Ä–æ–µ–∫—Ç–∞ –∏ –Ω–µ—Ç AI."); return false; }
            return true;
        }
        function checkAIPremium() {
            if ((db.premiumUntil && new Date(db.premiumUntil) > new Date()) || db.isPremium === true) return true;
            alert("üîí –≠—Ç–∞ AI-—Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ Premium."); return false;
        }
        function applyAITags(text) {
            const map = {'–º–∞–≥–∞–∑–∏–Ω':'@–ú–∞–≥–∞–∑–∏–Ω','–∫—É–ø–∏—Ç—å':'@–ú–∞–≥–∞–∑–∏–Ω','–Ω–∞–ø–∏—Å–∞—Ç—å':'@–ö–æ–º–ø—å—é—Ç–µ—Ä','–∫–æ–¥':'@–ö–æ–º–ø—å—é—Ç–µ—Ä','–ø–æ–∑–≤–æ–Ω–∏—Ç—å':'@–ó–≤–æ–Ω–∫–∏','–æ–ø–ª–∞—Ç–∏—Ç—å':'@–§–∏–Ω–∞–Ω—Å—ã'};
            let det = []; Object.keys(map).forEach(k => { if (text.toLowerCase().includes(k)) det.push(map[k]); });
            return [...new Set(det)];
        }
        function checkDuplicates(text) {
            const found = [...db.inbox, ...db.today].find(t => t.text.toLowerCase().includes(text.toLowerCase()));
            if (found && found.text.length > 4) return confirm(`ü§ñ AI: –ü–æ—Ö–æ–∂–∞—è –∑–∞–¥–∞—á–∞ —É–∂–µ –µ—Å—Ç—å ("${found.text}"). –°–æ–∑–¥–∞—Ç—å?`);
            return true;
        }
        function isTwoMinuteTask(text) { return ['–ø–æ–∑–≤–æ–Ω–∏—Ç—å','—Å–∫–∏–Ω—É—Ç—å','–æ—Ç–ø—Ä–∞–≤–∏—Ç—å','–æ–ø–ª–∞—Ç–∏—Ç—å'].some(v => text.toLowerCase().startsWith(v)); }

        /* --- AI FOCUS --- */
        window.activateFocusMode = function() {
            if (!checkAIPremium()) return;
            if (db.today.length === 0) return alert("–°–ø–∏—Å–æ–∫ '–°–µ–≥–æ–¥–Ω—è' –ø—É—Å—Ç.");
            
            // Score tasks
            let scored = db.today.map(t => {
                let score = 0;
                if (t.isQuick) score += 50; 
                if (t.text.length > 20) score += 10;
                if (t.tags && t.tags.length > 0) score += 20;
                score += Math.random() * 15;
                return { ...t, score };
            });
            scored.sort((a,b) => b.score - a.score);
            const top3 = scored.slice(0, 3);
            
            const cont = document.getElementById('focus-list-container');
            cont.innerHTML = '';
            top3.forEach((t, i) => {
                cont.innerHTML += `<div class="focus-item"><div class="focus-num">${i+1}</div><div class="focus-text">${t.text}</div></div>`;
            });
            document.getElementById('focus-modal').style.display = 'flex';
        }

        /* --- UI RENDER --- */
        window.renderCurrentView = function() {
            const container = document.getElementById('app-view');
            const bgCanvas = document.getElementById('bg-canvas');
            if (currentView === 'inbox') bgCanvas.style.opacity = '0.15'; else bgCanvas.style.opacity = '0';

            const headers = { 'inbox': 'üì• –í—Ö–æ–¥—è—â–∏–µ', 'today': 'üî• –°–µ–≥–æ–¥–Ω—è', 'calendar': 'üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å', 'projects': 'üèó –ü—Ä–æ–µ–∫—Ç—ã', 'waiting': 'üëÄ –ñ–¥—É –æ—Ç–≤–µ—Ç–∞', 'someday': 'üí° –û–¥–Ω–∞–∂–¥—ã', 'reference': 'üìö –ê—Ä—Ö–∏–≤', 'done': '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ', 'trash': 'üóë –ö–æ—Ä–∑–∏–Ω–∞' };
            let html = `<div class="header"><div class="title">${headers[currentView]}</div>`;
            if(currentView === 'done' || currentView === 'trash') html += `<button class="btn-action delete" onclick="empty${currentView === 'done'?'Done':'Trash'}()">–û—á–∏—Å—Ç–∏—Ç—å</button>`;
            html += `</div>`;
            
            if(!db[currentView]) db[currentView] = [];
            
            if (currentView === 'inbox') {
                html += `<div class="input-wrapper"><div class="input-group">
                    <input type="text" id="main-input" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" onkeypress="if(event.key==='Enter') addTask()">
                    <button class="btn-mic" id="btn-mic" onclick="startVoiceInput()"><i class="ph-fill ph-microphone"></i></button>
                    <button class="btn-add" onclick="addTask()"><i class="ph ph-plus"></i></button>
                </div></div>`;
                if(db.inbox.length > 0) html += `<button class="btn-wizard" onclick="startWizard()"><i class="ph-bold ph-lightning" style="font-size:20px;"></i> –†–ê–ó–û–ë–†–ê–¢–¨ –ò–ù–ë–û–ö–° (${db.inbox.length})</button>`;
            }
            
            if (currentView === 'today' && db.today.length > 0) {
                html += `<button class="btn-wizard" style="background:rgba(250, 204, 21, 0.1); color:#FACC15; border-color:rgba(250, 204, 21, 0.3); margin-bottom:16px;" onclick="activateFocusMode()"><i class="ph-fill ph-lightning"></i> AI Focus: –ß—Ç–æ –¥–µ–ª–∞—Ç—å?</button>`;
            }
            
            html += `<div class="task-list">`;
            let list = [...db[currentView]];
            if (currentView === 'today') list.sort((a, b) => (b.isQuick === true) - (a.isQuick === true));

            if(list.length === 0) { 
                if (currentView === 'inbox') {
                    html += `<div class="empty-state-container">
                        <div style="text-align:center; color:var(--text-secondary); margin-bottom:12px;">–í—Ö–æ–¥—è—â–∏—Ö –Ω–µ—Ç. –û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üéâ</div>
                        <div class="empty-card" onclick="document.getElementById('main-input').focus()"><div class="empty-icon-box" style="background: rgba(62, 123, 255, 0.1); color: #3E7BFF;"><i class="ph-fill ph-plus-circle"></i></div><div class="empty-text"><strong>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</strong><span>–ë—ã—Å—Ç—Ä—ã–π —Å–±—Ä–æ—Å</span></div></div>
                        <div class="empty-card" onclick="switchView('projects')"><div class="empty-icon-box" style="background: rgba(168, 85, 247, 0.1); color: #A855F7;"><i class="ph-fill ph-rocket-launch"></i></div><div class="empty-text"><strong>–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</strong><span>–°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω —á–µ—Ä–µ–∑ AI</span></div></div>
                        <div class="empty-card" onclick="openSearch()"><div class="empty-icon-box" style="background: rgba(255, 255, 255, 0.1); color: #fff;"><i class="ph-fill ph-magnifying-glass"></i></div><div class="empty-text"><strong>–ù–∞–π—Ç–∏ –∑–∞–¥–∞—á—É</strong><span>–ü–æ–∏—Å–∫ –≤–µ–∑–¥–µ</span></div></div>
                    </div>`;
                } else html += `<div style="text-align:center; color:var(--text-secondary); margin-top:60px;"><i class="ph ph-coffee" style="font-size:48px;"></i><br>–ó–∞–¥–∞—á –Ω–µ—Ç</div>`; 
            } else {
                if (currentView === 'projects') {
                      list.forEach(item => {
                        const progress = (item.steps||[]).filter(s=>s.completed).length + '/' + (item.steps||[]).length;
                        html += `<div class="task-card"><div class="task-top-row"><div style="font-weight:700; font-size:18px; flex:1;">${item.title}</div><div class="actions"><button class="btn-action" onclick="editProject(${item.id})"><i class="ph ph-pencil-simple"></i></button><button class="btn-action delete" onclick="moveToTrash('${currentView}', ${item.id})"><i class="ph ph-trash"></i></button></div></div><div style="font-size:15px; color:var(--text-secondary);">üéØ ${item.goal}</div><div class="project-progress-bar"><span style="display:flex; gap:8px;"><i class="ph ph-footprints"></i> –ü—Ä–æ–≥—Ä–µ—Å—Å</span><span>${progress}</span></div></div>`;
                      });
                } else { 
                    list.forEach((item, index) => { 
                        let prefix = currentView === 'inbox' ? `<span style="opacity:0.5; margin-right:6px;">${index+1}.</span>` : '';
                        html += createCard(item, currentView === 'done', false, prefix); 
                    }); 
                }
            }
            html += `</div>`; container.innerHTML = html; updateBadges();
        }

        window.createCard = function(item, isDoneView, isProjectCard, prefixHtml = '') {
            let metaHtml = '';
            if(item.isQuick) metaHtml += `<span class="tag quick"><i class="ph-fill ph-lightning"></i> 2 –º–∏–Ω</span>`;
            if(item.tags) item.tags.forEach(t => metaHtml += `<span class="tag context-tag">${t}</span>`);
            if(item.dateStr) metaHtml += `<span class="tag">${formatDateRUS(item.dateStr)}</span>`;
            
            let buttons = '';
            if(['inbox', 'today', 'calendar', 'waiting', 'someday'].includes(currentView)) buttons += `<button class="btn-action" onclick="editTask(${item.id})"><i class="ph ph-pencil-simple"></i></button>`;
            
            if(['today', 'projects', 'calendar', 'waiting', 'done'].includes(currentView)) {
                 buttons += `<button class="btn-action" onclick="showTaskInfo(${item.id})"><i class="ph-bold ph-info"></i></button>`;
            }

            if(!['trash','done'].includes(currentView)) { 
                buttons += `<button class="btn-action ai-magic" onclick="magicDecompose(${item.id})"><i class="ph-bold ph-magic-wand"></i></button>`;
                buttons += `<button class="btn-action" onclick="openMoveModal(${item.id})"><i class="ph ph-folder-notch-open"></i></button>`; 
                buttons += `<button class="btn-action delete" onclick="moveToTrash('${currentView}', ${item.id})"><i class="ph ph-trash"></i></button>`;
            } else if (currentView === 'trash') { 
                buttons += `<button class="btn-action" onclick="restoreFromTrash(${item.id})"><i class="ph ph-arrow-u-up-left"></i></button><button class="btn-action delete" onclick="permanentDelete(${item.id})"><i class="ph ph-x"></i></button>`; 
            } else if (isDoneView) { 
                buttons += `<button class="btn-action" onclick="undoComplete(${item.id})"><i class="ph-bold ph-arrow-u-up-left"></i></button><button class="btn-action delete" onclick="moveToTrash('done', ${item.id})"><i class="ph ph-trash"></i></button>`; 
            }

            const displayTitle = item.title || item.text;
            const checkAction = `completeTask('${currentView}', ${Number(item.id)})`;
            let checkboxHtml = '';
            if(['today','calendar','inbox','waiting','someday'].includes(currentView)) { checkboxHtml = `<div class="task-check" onclick="${checkAction}"><i class="ph-bold ph-check"></i></div>`; } else if (isDoneView) { checkboxHtml = `<div class="task-check checked"><i class="ph-bold ph-check"></i></div>`; }
            
            const cardClass = item.isQuick ? 'task-card quick-task' : 'task-card';
            return `<div class="${cardClass}"><div class="task-top-row">${checkboxHtml}<div class="task-title" style="${isDoneView?'text-decoration:line-through; opacity:0.5':''}">${prefixHtml} ${displayTitle}</div></div><div class="task-bottom-row"><div class="task-meta">${metaHtml}</div><div class="actions">${buttons}</div></div></div>`;
        }

        /* --- ACTIONS --- */
        window.addTask = function(overrideText = null) { 
            window.haptic('light'); 
            const input = document.getElementById('main-input');
            const val = overrideText || input.value.trim(); 
            if(!val) return; 
            if (checkAIPremium() && !checkDuplicates(val)) return;
            if(!db.inbox) db.inbox = []; 
            let task = { id: Date.now(), text: val, created: new Date().toISOString(), isQuick: isTwoMinuteTask(val) };
            if (checkAIPremium()) { const tags = applyAITags(val); if (tags.length) task.tags = tags; }
            db.inbox.unshift(task); if (!overrideText) input.value = ''; renderCurrentView(); saveDB(); 
        }
        window.editTask = function(id) { const t = db[currentView].find(x=>x.id===id); if(t) openInput('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å', (v)=>{ t.text=v; t.tags=applyAITags(v); saveDB(); }); setTimeout(()=>document.getElementById('input-modal-field').value=t.text,100); }
        window.switchView = function(view) { window.haptic('light'); currentView = view; document.querySelectorAll('.nav-item, .menu-item').forEach(el => el.classList.remove('active')); document.querySelectorAll(`[onclick="switchView('${view}')"]`).forEach(el => el.classList.add('active')); renderCurrentView(); }
        window.magicDecompose = async function(id) { if (!checkAIPremium()) return; const task = db[currentView].find(t => t.id === id); if(!task) return; if(!confirm(`ü™Ñ –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –∑–∞–¥–∞—á—É "${task.text}" –≤ –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç?`)) return; window.haptic('medium'); openProjectModal(null, task); setTimeout(() => askAIForSteps(), 500); }
        window.activatePromo = async function() { const code = document.getElementById('promo-input').value.trim(); if (!code) return; try { const res = await fetch(`${API_URL}/api/promo`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: currentUserID, code: code }) }); const data = await res.json(); if (data.success) { alert('üéâ ' + data.message); if (data.newPremiumUntil) { db.premiumUntil = data.newPremiumUntil; db.isPremium = true; openSettings(); } closeModal('settings-modal'); } else { alert('‚ùå ' + data.message); } } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); } }
        
        window.sendFeedback = async function() { 
            const textField = document.getElementById('feedback-text');
            const text = textField.value.trim(); 
            if(!text) return; 
            try { 
                await fetch(`${API_URL}/api/feedback`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: currentUserID, text: text, name: tg.initDataUnsafe?.user?.first_name || 'Guest' }) }); 
                alert("–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!"); 
                textField.value = ''; 
                closeModal('settings-modal'); 
            } catch(e) { alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏"); } 
        }

        /* --- FIXED AI FEATURES --- */
        window.generateWeeklyReview = async function() {
            if (!checkAIPremium()) return;
            const btn = document.getElementById('btn-week-review');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> –ê–Ω–∞–ª–∏–∑...';
            btn.disabled = true;

            const doneCount = (db.done || []).length;
            const inboxCount = (db.inbox || []).length;
            const todayCount = (db.today || []).length;
            const projectCount = (db.projects || []).length;

            const prompt = `–Ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã GTD. –°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π "Weekly Review" (–ù–µ–¥–µ–ª—å–Ω—ã–π –æ–±–∑–æ—Ä). –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞—á –≤—Å–µ–≥–æ: ${doneCount}. –í–æ –≤—Ö–æ–¥—è—â–∏—Ö –≤–∏—Å–∏—Ç: ${inboxCount}. –ù–∞ —Å–µ–≥–æ–¥–Ω—è: ${todayCount}. –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤: ${projectCount}. –î–∞–π –∫—Ä–∞—Ç–∫—É—é –æ—Ü–µ–Ω–∫—É –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ 1 —Å–æ–≤–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏.`;

            try {
                const res = await fetch(`${API_URL}/api/ask-ai`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: prompt, initData: tg.initData }) });
                const data = await res.json();
                if(data.reply) {
                    const cleanText = data.reply.replace(/\*\*/g, '').replace(/##/g, '').trim(); // Simple cleanup
                    document.getElementById('review-content').innerText = cleanText;
                    closeModal('settings-modal');
                    document.getElementById('review-modal').style.display = 'flex';
                } else {
                    alert("AI –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
                }
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI.");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        window.retroactiveTagging = async function() {
            if (!checkAIPremium()) return;
            const btn = document.getElementById('btn-auto-tag');
            btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> –°–∫–∞–Ω–∏—Ä—É—é...';
            btn.disabled = true;

            let updatedCount = 0;
            const folders = ['inbox', 'today', 'waiting', 'someday'];
            
            folders.forEach(folder => {
                if(db[folder]) {
                    db[folder].forEach(task => {
                        const newTags = applyAITags(task.text || "");
                        if (newTags.length > 0) {
                            // Merge existing tags with new ones uniquely
                            const existing = task.tags || [];
                            const merged = [...new Set([...existing, ...newTags])];
                            if (merged.length > existing.length) {
                                task.tags = merged;
                                updatedCount++;
                            }
                        }
                    });
                }
            });

            if (updatedCount > 0) {
                saveDB();
                alert(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–¥–∞—á: ${updatedCount}. –¢–µ–≥–∏ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã.`);
                closeModal('settings-modal');
            } else {
                alert("üîç –ù–æ–≤—ã—Ö —Ç–µ–≥–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.");
            }
            
            btn.innerHTML = '<i class="ph-bold ph-tag"></i> –û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–≥–∏ (AI)';
            btn.disabled = false;
        }

        window.showTaskInfo = function(id) {
            let item = db[currentView].find(t => t.id === id);
            if(!item && currentView === 'projects') item = db.projects.find(p => p.id === id);
            if(!item) return;

            let msg = `üìÖ –°–æ–∑–¥–∞–Ω–æ: ${new Date(item.created || item.id).toLocaleString()}`;
            if(item.completedAt) {
                msg += `\n‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${item.completedAt}`;
            }
            alert(msg);
        }

        window.haptic = function(style = 'light') { try { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred(style); } catch(e){} }
        window.formatDateRUS = function(isoDate) { if(!isoDate) return ''; const parts = isoDate.split('-'); if(parts.length !== 3) return isoDate; return `${parts[2]}.${parts[1]}.${parts[0]}`; }
        window.moveToTrash = function(from, id) { window.haptic('medium'); const idx = db[from].findIndex(t => t.id === id); if(idx > -1) { const item = db[from].splice(idx, 1)[0]; item.originalFolder = from; if(!db.trash) db.trash = []; db.trash.unshift(item); renderCurrentView(); saveDB(); } }
        window.restoreFromTrash = function(id) { window.haptic('light'); const idx = db.trash.findIndex(t => t.id === id); if(idx > -1) { const item = db.trash.splice(idx, 1)[0]; db[item.originalFolder || 'inbox'].push(item); renderCurrentView(); saveDB(); } }
        window.permanentDelete = function(id) { window.haptic('heavy'); if(confirm("–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?")) { db.trash = db.trash.filter(t => t.id !== id); renderCurrentView(); saveDB(); } }
        window.emptyDone = function() { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ?")) { if(!db.trash) db.trash = []; db.trash.push(...db.done.map(i => ({...i, originalFolder: 'done'}))); db.done = []; renderCurrentView(); saveDB(); } }
        window.emptyTrash = function() { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?")) { db.trash = []; renderCurrentView(); saveDB(); } }
        window.undoComplete = function(id) { window.haptic('light'); const idx = db.done.findIndex(t => t.id === id); if(idx > -1) { const item = db.done.splice(idx, 1)[0]; delete item.completedAt; if(item.isProject) db.projects.unshift(item); else db.today.unshift(item); renderCurrentView(); saveDB(); } }
        window.completeTask = function(from, id) { window.haptic('success'); id = Number(id); const idx = db[from].findIndex(t => t.id === id); if(idx === -1) return; const task = db[from][idx]; if (task.projectId) { const project = db.projects.find(p => p.id === task.projectId); if (project) { const step = project.steps.find(s => s.id === task.stepId); if(step) step.completed = true; const nextStep = project.steps.find(s => !s.completed); if(nextStep) { alert(`–û—Ç–ª–∏—á–Ω–æ! –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: "${nextStep.text}"`); db.today.push({ id: Date.now(), text: nextStep.text, projectId: project.id, projectTitle: project.title, stepId: nextStep.id, isProject: false }); } else { alert("üéâ –ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!"); db.projects = db.projects.filter(p => p.id !== project.id); project.isProject = true; project.completedAt = new Date().toLocaleString(); if(!db.done) db.done = []; db.done.unshift(project); } } db[from].splice(idx, 1); } else { const item = db[from].splice(idx, 1)[0]; item.completedAt = new Date().toLocaleString(); if(!db.done) db.done = []; db.done.unshift(item); } renderCurrentView(); saveDB(); }
        window.startWizard = function() { if(db.inbox.length===0) return; window.haptic('light'); wizardTask=db.inbox[db.inbox.length - 1]; wizardStep=0; document.getElementById('wizard-modal').style.display='flex'; renderWizard(); }
        
        /* WIZARD VISUALS */
        let wizardTask=null, wizardStep=0, questions = [ { text: "–ù—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å?", icon: "ph-person-simple-run", no: "reference", noTxt: "–ù–µ—Ç (–ê—Ä—Ö–∏–≤)", yesTxt: "–î–∞" }, { text: "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ?", icon: "ph-calendar-plus", no: "someday", noTxt: "–ù–µ—Ç (–ü–æ—Ç–æ–º)", yesTxt: "–î–∞" }, { text: "–î–µ–ª–∞—Ç—å –ú–ù–ï?", icon: "ph-users-three", no: "DELEGATE", noTxt: "–ù–µ—Ç (–ü–æ—Ä—É—á–∏—Ç—å)", yesTxt: "–î–∞" }, { text: "–≠—Ç–æ 1 —à–∞–≥?", icon: "ph-steps", no: "PROJECT", noTxt: "–ù–µ—Ç (–ü—Ä–æ–µ–∫—Ç)", yesTxt: "–î–∞" }, { text: "< 2 –º–∏–Ω—É—Ç?", icon: "ph-lightning", yes: "DO_NOW", yesTxt: "–î–∞ (–°–µ–π—á–∞—Å)", noTxt: "> 2 –º–∏–Ω" }, { text: "–ñ–µ—Å—Ç–∫–∞—è –¥–∞—Ç–∞?", icon: "ph-calendar-check", yes: "CALENDAR", yesTxt: "–î–∞ (–ö–∞–ª–µ–Ω–¥–∞—Ä—å)", noTxt: "–ù–µ—Ç (–í –°–µ–≥–æ–¥–Ω—è)" } ];
        window.renderWizard = function() { const q = questions[wizardStep]; document.getElementById('wizard-task-text').innerText = wizardTask.text; document.getElementById('wizard-question-text').innerText = q.text; document.getElementById('wizard-icon').className = `ph-fill ${q.icon}`; document.getElementById('btn-no').innerText = q.noTxt; document.getElementById('btn-yes').innerText = q.yesTxt; }
        
        window.handleWizardAnswer = function(yes) { 
            window.haptic('light'); 
            const q = questions[wizardStep]; 
            
            if(!yes) { 
                if(q.no==='reference') return moveTo('reference'); 
                if(q.no==='someday') return moveTo('someday'); 
                if(q.no==='DELEGATE') { openInput('–ö–æ–º—É?', (n)=>{ setTimeout(()=>openDateModal((d)=>moveTo('waiting',{assignee:n, dateStr:d})),200); }); return; } 
                if(q.no==='PROJECT') { openProjectModal(null, wizardTask); return; } 
            } else { 
                if(q.yes==='DO_NOW') { 
                    moveTo('today', { isQuick: true }); 
                    return; 
                } 
                if(q.yes==='CALENDAR') { 
                    closeModal('wizard-modal'); 
                    setTimeout(() => openDateModal((d,t)=>moveTo('calendar',{dateStr:d, timeStr:t})), 100);
                    return; 
                } 
            } 
            wizardStep++; 
            if(wizardStep>=questions.length) moveTo('today'); 
            else renderWizard(); 
        }
        
        window.moveTo = function(f, e={}) { 
            db.inbox = db.inbox.filter(t => t.id !== wizardTask.id); 
            if(!db[f]) db[f]=[]; 
            db[f].unshift({...wizardTask, ...e, id:Date.now()}); 
            
            closeModal('wizard-modal'); 
            closeModal('input-modal'); 
            closeModal('date-modal'); 

            renderCurrentView(); 
            saveDB(); 

            if(db.inbox.length>0) {
                setTimeout(startWizard, 300); 
            }
        }
        
        window.closeModal = function(id) { document.getElementById(id).style.display='none'; }
        window.openInput = function(t, cb) { document.getElementById('input-modal').style.display='flex'; document.getElementById('input-modal-title').innerText=t; window.inputCallback=cb; }
        window.submitInputModal = function() { const v=document.getElementById('input-modal-field').value; if(v&&window.inputCallback) window.inputCallback(v); closeModal('input-modal'); }
        window.openDateModal = function(cb) { document.getElementById('date-modal').style.display='flex'; window.dateCallback=cb; }
        window.submitDateModal = function() { const d=document.getElementById('calendar-date').value; const t=document.getElementById('calendar-time').value; if(d&&window.dateCallback) window.dateCallback(d,t); closeModal('date-modal'); }
        window.openMoveModal = function(id) { window.moveTaskId=id; document.getElementById('move-modal').style.display='flex'; }
        window.submitMove = function(f) { if(!window.moveTaskId)return; const idx=db[currentView].findIndex(t=>t.id===window.moveTaskId); if(idx>-1) { const i=db[currentView].splice(idx,1)[0]; if(!db[f]) db[f]=[]; db[f].unshift(i); renderCurrentView(); saveDB(); } closeModal('move-modal'); }
        
        /* SEARCH & PROJECT */
        window.openSearch = function() { document.getElementById('search-modal').style.display = 'flex'; document.getElementById('search-input').focus(); performSearch(); }
        window.performSearch = function() {
            const q = document.getElementById('search-input').value.toLowerCase();
            const res = document.getElementById('search-results'); res.innerHTML = '';
            if(q.length<1) return res.innerHTML = '<div style="text-align:center;color:#94A3B8">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å...</div>';
            
            const all=[]; 
            // Fix: Normalize data structure. Projects have 'title', tasks have 'text'.
            ['inbox','today','projects','waiting','someday','done'].forEach(v=>{ 
                if(db[v]) db[v].forEach(t=>{
                    // Create a normalized search string combining text and title
                    const searchStr = (t.text || t.title || "").toLowerCase();
                    all.push({...t, s:v, searchStr: searchStr})
                }) 
            });
            
            const found = all.filter(t=>t.searchStr.includes(q));
            
            if(found.length===0) res.innerHTML='<div style="text-align:center;color:#94A3B8">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            else found.forEach(t=>{ 
                // Display Title for projects or Text for tasks
                const display = t.title || t.text || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
                res.innerHTML+=`<div onclick="closeModal('search-modal');switchView('${t.s}')" style="background:rgba(255,255,255,0.05);padding:12px;border-radius:12px;cursor:pointer;"><div style="font-weight:600;color:#fff">${display}</div><div style="font-size:12px;color:#3E7BFF">${t.s.toUpperCase()}</div></div>` 
            });
        }
        
        let tempSteps=[];
        window.openProjectModal = function(eid=null, src=null) { closeModal('wizard-modal'); document.getElementById('project-modal').style.display='flex'; tempSteps=[]; const aiBtn = document.getElementById('btn-ai-magic'); if(aiBtn) aiBtn.style.display = checkPremiumLimits() ? 'block' : 'none'; if(eid) { const p=db.projects.find(x=>x.id===eid); document.getElementById('proj-edit-id').value=eid; document.getElementById('proj-name').value=p.title; document.getElementById('proj-goal').value=p.goal; tempSteps=JSON.parse(JSON.stringify(p.steps)); } else { document.getElementById('proj-edit-id').value=""; document.getElementById('proj-name').value=src ? src.text : ''; document.getElementById('proj-goal').value=""; } renderSteps(); }
        window.addStepToUI = function() { const v=document.getElementById('proj-new-step').value; if(v) { tempSteps.push({id:Date.now(), text:v, completed:false}); document.getElementById('proj-new-step').value=''; renderSteps(); } }
        window.removeStep = function(i) { tempSteps.splice(i,1); renderSteps(); }
        window.renderSteps = function() { const c=document.getElementById('proj-steps-container'); c.innerHTML=''; tempSteps.forEach((s,i)=>{ c.innerHTML+=`<div class="step-row"><span>${i+1}.</span><input value="${s.text}" oninput="tempSteps[${i}].text=this.value"><i class="ph ph-x" style="color:red;padding:5px;" onclick="removeStep(${i})"></i></div>`; }); }
        window.askAIForSteps = async function() {
            if (!checkAIPremium()) return;
            const title = document.getElementById('proj-name').value;
            if(!title) return alert("–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!");
            const btn = document.getElementById('btn-ai-magic'); const old = btn.innerHTML;
            btn.innerHTML = '<i class="ph ph-spinner ph-spin"></i> –î—É–º–∞—é...'; btn.disabled = true;
            try {
                const res = await fetch(`${API_URL}/api/ask-ai`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: `–ü—Ä–æ–µ–∫—Ç: "${title}"`, initData: tg.initData }) });
                const data = await res.json();
                if(data.reply) { const lines = data.reply.split('\n').filter(l => l.trim().length > 0); lines.forEach(l => { tempSteps.push({id: Date.now()+Math.random(), text: l.replace(/^[\d\.\-\s]+/, ''), completed: false}); }); renderSteps(); }
            } catch (e) { alert("–û—à–∏–±–∫–∞ –ò–ò"); } finally { btn.innerHTML = old; btn.disabled = false; }
        }
        window.saveProject = function() { const eid=document.getElementById('proj-edit-id').value; if (!eid && !checkPremiumLimits()) return; const t=document.getElementById('proj-name').value; const g=document.getElementById('proj-goal').value; if(!t||!g||tempSteps.length===0) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å—ë!"); if(eid) { const i=db.projects.findIndex(p=>p.id==eid); if(i>-1) { db.projects[i].title=t; db.projects[i].goal=g; db.projects[i].steps=tempSteps; } } else { const nid=Date.now(); if(!db.projects) db.projects = []; db.projects.push({id:nid, title:t, goal:g, steps:tempSteps, isProject:true}); if(wizardTask) { db.inbox=db.inbox.filter(x=>x.id!==wizardTask.id); } db.today.push({id:Date.now()+1, text:tempSteps[0].text, projectId:nid, projectTitle:t, stepId:tempSteps[0].id, isProject:false}); } renderCurrentView(); saveDB(); closeModal('project-modal'); if(!eid&&db.inbox.length>0) setTimeout(startWizard,300); }
        window.openSettings = function() { document.getElementById('settings-modal').style.display = 'flex'; const sb = document.getElementById('premium-status-box'); if (db.premiumUntil && new Date(db.premiumUntil) > new Date()) { sb.innerHTML = `üíé <b>Premium</b><br>–î–æ: ${new Date(db.premiumUntil).toLocaleDateString()}`; document.getElementById('ai-review-btn-container').style.display='block'; } else { sb.innerHTML = `üåë <b>Free</b><div onclick="closeApp()" style="color:#991B1B;cursor:pointer;margin-top:5px">üëâ –ö–£–ü–ò–¢–¨</div>`; document.getElementById('ai-review-btn-container').style.display='none'; } }

        initSplash(); initUserInfo(); switchView('inbox');
    </script>
</body>
</html>

