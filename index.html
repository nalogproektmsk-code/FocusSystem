<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FocusSystem Cloud</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script type="text/javascript" >
       (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
       m[i].l=1*new Date();
       for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
       k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
       (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

       ym(106183159, "init", {
            clickmap:true,
            trackLinks:true,
            accurateTrackBounce:true,
            webvisor:true,
            ssr:true,
            ecommerce:"dataLayer"
       });
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/106183159" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

    <style>
        /* --- DESIGN SYSTEM VARS --- */
        :root {
            --bg-color: #F8FAFC; 
            --sidebar-bg: #FFFFFF;
            --card-bg: #FFFFFF;
            --primary-color: #F97316; 
            --primary-hover: #EA580C;
            --primary-text: #FFFFFF;
            --text-main: #1E293B; 
            --text-secondary: #64748B; 
            --border-color: #E2E8F0;
            --shadow-soft: 0 4px 20px rgba(148, 163, 184, 0.1);
            --shadow-hover: 0 10px 25px rgba(148, 163, 184, 0.15);
            --radius-xl: 20px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
            font-size: 15px; 
            line-height: 1.5;
        }
        
        /* --- SIDEBAR --- */
        .sidebar { 
            width: 260px; 
            background: var(--sidebar-bg); 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            padding: 32px 20px; 
            flex-shrink: 0; 
        }
        
        .logo { 
            font-size: 20px; 
            font-weight: 800; 
            margin-bottom: 40px; 
            color: var(--text-main); 
            padding-left: 12px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            letter-spacing: -0.5px;
        }
        .logo i { color: var(--primary-color); font-size: 24px; }

        .menu-item { 
            height: 44px; 
            padding: 0 16px; 
            cursor: pointer; 
            border-radius: var(--radius-md); 
            margin-bottom: 4px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 15px; 
            color: var(--text-secondary); 
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .menu-item:hover { background: #F1F5F9; color: var(--text-main); }
        .menu-item.active { background-color: #FFF7ED; color: var(--primary-color); }
        .menu-item span { display: flex; align-items: center; gap: 12px; }
        .menu-item i { font-size: 20px; }

        .badge { 
            background: #F1F5F9; 
            color: var(--text-secondary);
            padding: 2px 8px; 
            border-radius: 99px; 
            font-size: 12px; 
            font-weight: 700; 
            min-width: 20px;
            text-align: center;
        }
        .menu-item.active .badge { background: #FED7AA; color: #9A3412; }
        .spacer { height: 1px; background: var(--border-color); margin: 20px 0; }
        
        /* --- MOBILE NAV --- */
        .bottom-nav { 
            display: none; 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            padding-bottom: max(10px, env(safe-area-inset-bottom));
            padding-top: 10px;
            border-top: 1px solid var(--border-color); 
            z-index: 100; 
            overflow-x: auto; 
            white-space: nowrap; 
            scrollbar-width: none; 
            gap: 5px;
        }
        .nav-item { 
            display: inline-flex; flex-direction: column; align-items: center; justify-content: center; 
            min-width: 70px; padding: 5px; 
            color: var(--text-secondary); 
            font-size: 10px; font-weight: 600; 
            border-radius: 12px;
            transition: 0.2s;
        }
        .nav-item.active { color: var(--primary-color); }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }
        .nav-item.active .nav-icon { font-weight: bold; }

        @media (max-width: 768px) { 
            .sidebar { display: none; } 
            .bottom-nav { display: flex; } 
            .main { padding: 20px 16px; padding-bottom: 100px; } 
            .modal { width: 100% !important; border-radius: 24px 24px 0 0 !important; bottom: 0 !important; top: auto !important; max-height: 90vh; }
            .modal-overlay { align-items: flex-end; }
        }

        /* --- MAIN AREA --- */
        .main { flex: 1; padding: 48px; overflow-y: auto; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .header { margin-bottom: 32px; display: flex; justify-content: space-between; align-items: center; }
        .title { font-size: 28px; font-weight: 800; color: var(--text-main); letter-spacing: -0.03em; }
        
        .input-wrapper { position: relative; margin-bottom: 32px; box-shadow: var(--shadow-soft); border-radius: var(--radius-xl); background: #fff; transition: 0.2s; }
        .input-wrapper:focus-within { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
        .input-group { display: flex; gap: 0; background: transparent; padding: 6px; }
        
        input, textarea { flex: 1; padding: 16px 20px; border: none; font-size: 16px; font-family: 'Inter', sans-serif; outline: none; background: transparent; color: var(--text-main); }
        input::placeholder { color: #94A3B8; }
        
        .btn-add { background: var(--primary-color); color: white; width: 50px; height: 50px; border-radius: 14px; border: none; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; transition: 0.2s; }
        .btn-add:active { transform: scale(0.9); }
        
        .btn-wizard { width: 100%; background: linear-gradient(135deg, #10B981, #059669); color: white; margin-bottom: 24px; font-size: 15px; font-weight: 700; height: 48px; border-radius: var(--radius-md); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }

        /* --- TASKS --- */
        .task-list { display: flex; flex-direction: column; gap: 16px; }
        .task-card { background: var(--card-bg); padding: 20px; border-radius: var(--radius-xl); border: 1px solid transparent; display: flex; justify-content: space-between; align-items: flex-start; box-shadow: var(--shadow-soft); transition: all 0.2s ease; }
        .task-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); border-color: rgba(249, 115, 22, 0.3); }

        .task-left { display: flex; gap: 16px; align-items: flex-start; flex: 1; }
        .task-check { width: 24px; height: 24px; border: 2px solid #CBD5E1; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; color: transparent; margin-top: 2px; transition: 0.2s; }
        .task-check:hover { border-color: var(--primary-color); }
        .task-check.checked { background: var(--success); border-color: var(--success); color: white; }

        .task-content { flex: 1; padding-right: 10px; }
        .task-title { font-weight: 600; font-size: 16px; line-height: 1.4; color: var(--text-main); margin-bottom: 8px; }
        .task-meta { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .tag { padding: 4px 10px; background: #F1F5F9; color: var(--text-secondary); border-radius: 6px; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
        .tag.quick { background: #FFF7ED; color: #EA580C; }
        .tag.date { background: #F0F9FF; color: #0284C7; }
        .tag.project { background: #F5F3FF; color: #7C3AED; }

        /* Actions */
        .actions { display: flex; gap: 4px; }
        .btn-action { width: 32px; height: 32px; border-radius: 8px; border: none; background: transparent; color: #94A3B8; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: 0.2s; }
        .btn-action:hover { background: #F1F5F9; color: var(--text-main); }
        .btn-action.delete:hover { background: #FEF2F2; color: var(--danger); }

        .section-title { font-size: 12px; font-weight: 800; color: var(--text-secondary); margin-top: 30px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal { background: #fff; width: 450px; padding: 32px; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border: 1px solid rgba(255,255,255,0.5); }
        .modal-header { font-size: 20px; font-weight: 800; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        
        .btn-primary { width: 100%; background: var(--primary-color); color: white; height: 48px; border-radius: 12px; border: none; font-weight: 600; font-size: 16px; cursor: pointer; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.25); }
        .wizard-buttons { display: flex; gap: 12px; margin-top: 32px; }
        .wizard-btn { flex: 1; padding: 16px; border-radius: 16px; border: 2px solid #F1F5F9; background: #fff; font-weight: 700; font-size: 16px; cursor: pointer; }
        .wizard-btn:hover { border-color: var(--primary-color); background: #FFF7ED; }
        .step-row { display: flex; gap: 12px; margin-bottom: 12px; align-items: center; padding: 8px 12px; background: #F8FAFC; border-radius: 12px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="ph-fill ph-rocket-launch"></i> GTD Focus</div>
        <div class="menu-item active" onclick="switchView('inbox')"><span><i class="ph ph-tray"></i> Inbox</span><span class="badge" id="badge-inbox">0</span></div>
        <div class="spacer"></div>
        <div class="menu-item" onclick="switchView('today')"><span><i class="ph ph-fire"></i> –°–µ–≥–æ–¥–Ω—è</span><span class="badge" id="badge-today">0</span></div>
        <div class="menu-item" onclick="switchView('calendar')"><span><i class="ph ph-calendar-blank"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å</span><span class="badge" id="badge-calendar">0</span></div>
        <div class="menu-item" onclick="switchView('projects')"><span><i class="ph ph-kanban"></i> –ü—Ä–æ–µ–∫—Ç—ã</span><span class="badge" id="badge-projects">0</span></div>
        <div class="menu-item" onclick="switchView('waiting')"><span><i class="ph ph-clock-user"></i> –ü–æ—Ä—É—á–µ–Ω–∏—è</span><span class="badge" id="badge-waiting">0</span></div>
        <div class="menu-item" onclick="switchView('someday')"><span><i class="ph ph-lightbulb"></i> –ü–æ—Ç–æ–º</span><span class="badge" id="badge-someday">0</span></div>
        <div class="menu-item" onclick="switchView('reference')"><span><i class="ph ph-archive-box"></i> –ê—Ä—Ö–∏–≤</span><span class="badge" id="badge-reference">0</span></div>
        <div class="spacer"></div>
        <div class="menu-item" onclick="switchView('done')"><span><i class="ph ph-check-circle"></i> –ì–æ—Ç–æ–≤–æ</span><span class="badge" id="badge-done">0</span></div>
        <div class="menu-item" onclick="switchView('trash')"><span><i class="ph ph-trash"></i> –ö–æ—Ä–∑–∏–Ω–∞</span><span class="badge" id="badge-trash">0</span></div>
    </div>

    <div class="main"><div id="app-view"></div></div>

    <nav class="bottom-nav">
        <div style="width: 10px; flex-shrink: 0;"></div>
        <div class="nav-item active" onclick="switchView('inbox')"><div class="nav-icon"><i class="ph ph-tray"></i></div>Inbox <span id="mob-badge-inbox"></span></div>
        <div class="nav-item" onclick="switchView('today')"><div class="nav-icon"><i class="ph ph-fire"></i></div>–°–µ–≥–æ–¥–Ω—è <span id="mob-badge-today"></span></div>
        <div class="nav-item" onclick="switchView('calendar')"><div class="nav-icon"><i class="ph ph-calendar-blank"></i></div>–ö–∞–ª–µ–Ω–¥.</div>
        <div class="nav-item" onclick="switchView('projects')"><div class="nav-icon"><i class="ph ph-kanban"></i></div>–ü—Ä–æ–µ–∫—Ç—ã</div>
        <div class="nav-item" onclick="switchView('waiting')"><div class="nav-icon"><i class="ph ph-clock-user"></i></div>–ü–æ—Ä—É—á.</div>
        <div class="nav-item" onclick="switchView('someday')"><div class="nav-icon"><i class="ph ph-lightbulb"></i></div>–ü–æ—Ç–æ–º</div>
        <div class="nav-item" onclick="switchView('reference')"><div class="nav-icon"><i class="ph ph-archive-box"></i></div>–ê—Ä—Ö–∏–≤</div>
        <div class="nav-item" onclick="switchView('done')"><div class="nav-icon"><i class="ph ph-check-circle"></i></div>–ì–æ—Ç–æ–≤–æ</div>
        <div class="nav-item" onclick="switchView('trash')"><div class="nav-icon"><i class="ph ph-trash"></i></div>–ö–æ—Ä–∑–∏–Ω–∞</div>
        <div style="width: 10px; flex-shrink: 0;"></div>
    </nav>

    <div id="wizard-modal" class="modal-overlay">
        <div class="modal">
            <div style="text-align:center; font-size:11px; text-transform:uppercase; color:var(--text-secondary); margin-bottom:12px; font-weight: 800; letter-spacing:1px;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ Inbox</div>
            <div style="text-align: center; margin-bottom: 24px;"><strong id="wizard-task-text" style="font-size: 20px; line-height: 1.4;">...</strong></div>
            <div id="wizard-question-text" style="text-align:center; font-size:20px; font-weight:600; margin:32px 0;">...</div>
            <div class="wizard-buttons">
                <button class="wizard-btn" style="color:var(--danger);" onclick="handleWizardAnswer(false)" id="btn-no">–ù–µ—Ç</button>
                <button class="wizard-btn" style="color:var(--success); border-color: rgba(16, 185, 129, 0.2);" onclick="handleWizardAnswer(true)" id="btn-yes">–î–∞</button>
            </div>
            <button onclick="closeModal('wizard-modal')" style="width:100%; margin-top:20px; border:none; background:none; color:var(--text-secondary); font-size:14px; padding: 10px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>
    
    <div id="project-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><span id="proj-modal-title">–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</span><i class="ph ph-x close-btn" onclick="closeModal('project-modal')"></i></div>
            <input type="hidden" id="proj-edit-id"> 
            <label style="display:block; font-size:11px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–ù–ê–ó–í–ê–ù–ò–ï</label>
            <input type="text" id="proj-name" style="width:100%; box-sizing:border-box; margin-bottom:20px; background:#F8FAFC; border-radius:12px;" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–¥–µ–ª–∞—Ç—å —Ä–µ–º–æ–Ω—Ç">
            <label style="display:block; font-size:11px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–†–ï–ó–£–õ–¨–¢–ê–¢ (–¶–ï–õ–¨)</label>
            <input type="text" id="proj-goal" placeholder="–ö–∞–∫ –ø–æ–π–º–µ—à—å, —á—Ç–æ –≥–æ—Ç–æ–≤–æ?" style="width:100%; box-sizing:border-box; margin-bottom:24px; background:#F8FAFC; border-radius:12px;">
            <label style="display:block; font-size:11px; font-weight:800; color:var(--text-secondary); margin-bottom:8px;">–ü–ï–†–í–´–ï –®–ê–ì–ò</label>
            <div id="proj-steps-container" style="margin-bottom: 12px;"></div>
            <div style="display:flex; gap:12px; margin-bottom:24px;">
                <input type="text" id="proj-new-step" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥..." style="flex:1; background:#F8FAFC; border-radius:12px;">
                <button class="btn-primary" style="width:50px;" onclick="addStepToUI()"><i class="ph ph-plus"></i></button>
            </div>
            <button class="btn-primary" onclick="saveProject()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        </div>
    </div>
    
    <div id="input-modal" class="modal-overlay"><div class="modal"><div class="modal-header" id="input-modal-title">–í–≤–æ–¥</div><input type="text" id="input-modal-field" style="width: 100%; box-sizing:border-box; margin-bottom: 24px; background:#F8FAFC; border-radius:12px;"><button class="btn-primary" onclick="submitInputModal()">–û–ö</button></div></div>
    <div id="date-modal" class="modal-overlay"><div class="modal"><div class="modal-header">üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</div><input type="date" id="calendar-date" style="width:100%; box-sizing:border-box; margin-bottom:16px; background:#F8FAFC; border-radius:12px;"><input type="time" id="calendar-time" style="width:100%; box-sizing:border-box; margin-bottom:24px; background:#F8FAFC; border-radius:12px;"><button class="btn-primary" onclick="submitDateModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>
    <div id="move-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">–ö—É–¥–∞ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å?</div>
            <div style="display:flex; flex-direction:column; gap:8px;">
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('inbox')"><span><i class="ph ph-tray"></i> Inbox</span></button>
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('today')"><span><i class="ph ph-fire"></i> –°–µ–≥–æ–¥–Ω—è</span></button>
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('calendar')"><span><i class="ph ph-calendar-blank"></i> –ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('waiting')"><span><i class="ph ph-clock-user"></i> –ü–æ—Ä—É—á–µ–Ω–∏—è</span></button>
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('someday')"><span><i class="ph ph-lightbulb"></i> –ü–æ—Ç–æ–º</span></button>
                <button class="menu-item" style="border:none; width:100%; background:#F8FAFC;" onclick="submitMove('reference')"><span><i class="ph ph-archive-box"></i> –ê—Ä—Ö–∏–≤</span></button>
            </div>
            <button onclick="closeModal('move-modal')" style="width:100%; margin-top:20px; border:none; background:none; color:var(--text-secondary); font-size:14px; padding: 10px; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyALuLfaVgYjc3rHXJz9g8TMJpO9Lzryfj4",
            authDomain: "gtd-focus-app.firebaseapp.com",
            databaseURL: "https://gtd-focus-app-default-rtdb.firebaseio.com",
            projectId: "gtd-focus-app",
            storageBucket: "gtd-focus-app.firebasestorage.app",
            messagingSenderId: "54533448500",
            appId: "1:54533448500:web:0c59c28d63ce03af1abb61",
            measurementId: "G-D0PNMT824K"
        };

        const app = initializeApp(firebaseConfig);
        const dbRef = getDatabase(app);

        // --- CORE APP VARIABLES ---
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        let db = { inbox: [], today: [], calendar: [], projects: [], waiting: [], someday: [], reference: [], done: [], trash: [], isPremium: false };
        let currentView = 'inbox';
        let currentUserID = 'guest_user';

        // --- AUTH & INIT ---
        function initUserInfo() {
            const user = tg.initDataUnsafe?.user;
            if (user) {
                currentUserID = String(user.id);
                const name = user.first_name;
                const logoEl = document.querySelector('.logo');
                if (logoEl) logoEl.innerHTML = `<i class="ph-fill ph-rocket-launch"></i> ${name}'s Focus`;
                
                if (typeof ym !== 'undefined') {
                    ym(106183159, 'userParams', { UserID: user.id, UserName: user.username, Name: user.first_name });
                }
            } else {
                let storedId = localStorage.getItem('gtd_guest_id');
                if(!storedId) { storedId = 'web_' + Date.now(); localStorage.setItem('gtd_guest_id', storedId); }
                currentUserID = storedId;
            }
            
            const userRef = ref(dbRef, 'users/' + currentUserID);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    db = data; 
                } else {
                    saveDB(); 
                }
                updateBadges();
                renderCurrentView();
            });
        }

        // --- DB FUNCTIONS (CLOUD) ---
        function saveDB() {
            set(ref(dbRef, 'users/' + currentUserID), db);
            updateBadges();
            renderCurrentView();
        }

        // --- PREMIUM CHECKER ---
        function checkPremiumLimits() {
            if (db.isPremium) return true;
            const activeProjects = (db.projects || []).filter(p => !p.completedAt).length;
            if (activeProjects >= 3) {
                alert("üíé –õ–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏!\n\n–í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Å—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —Ç–æ–ª—å–∫–æ 3 –ø—Ä–æ–µ–∫—Ç–∞.\n\n–ß—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫—É, –æ—Ñ–æ—Ä–º–∏—Ç–µ Premium.");
                return false; 
            }
            return true;
        }

        // --- GLOBAL FUNCTIONS EXPORT ---
        window.haptic = function(style = 'light') {
            try { if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred(style); } catch(e){}
        }

        window.formatDateRUS = function(isoDate) {
            if(!isoDate) return '';
            const parts = isoDate.split('-');
            if(parts.length !== 3) return isoDate;
            return `${parts[2]}.${parts[1]}.${parts[0]}`;
        }

        window.switchView = function(view) {
            window.haptic('light');
            currentView = view;
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            const items = document.querySelectorAll('.menu-item');
            for(let item of items) { if(item.getAttribute('onclick').includes(view)) { item.classList.add('active'); break; } }
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navItems = document.querySelectorAll('.nav-item');
            for(let item of navItems) {
                if(item.getAttribute('onclick').includes(view)) { 
                    item.classList.add('active'); 
                    item.scrollIntoView({ behavior: 'smooth', inline: 'center' }); 
                    break; 
                }
            }
            renderCurrentView();
        }

        window.renderCurrentView = function() {
            const container = document.getElementById('app-view');
            const headers = { 'inbox': 'üì• –í—Ö–æ–¥—è—â–∏–µ', 'today': 'üî• –°–µ–≥–æ–¥–Ω—è', 'calendar': 'üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å', 'projects': 'üèó –ü—Ä–æ–µ–∫—Ç—ã', 'waiting': 'üëÄ –ñ–¥—É –æ—Ç–≤–µ—Ç–∞', 'someday': 'üí° –û–¥–Ω–∞–∂–¥—ã', 'reference': 'üìö –ê—Ä—Ö–∏–≤', 'done': '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ', 'trash': 'üóë –ö–æ—Ä–∑–∏–Ω–∞' };

            let html = `<div class="header"><div class="title">${headers[currentView]}</div>`;
            if(currentView === 'trash' && db.trash && db.trash.length > 0) html += `<button class="btn-action delete" onclick="emptyTrash()" style="width:auto; padding:0 10px; font-size:13px;">–û—á–∏—Å—Ç–∏—Ç—å</button>`;
            html += `</div>`;

            if(!db[currentView]) db[currentView] = [];

            if (currentView === 'inbox') {
                html += `
                <div class="input-wrapper">
                    <div class="input-group">
                        <input type="text" id="main-input" placeholder="–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?" onkeypress="if(event.key==='Enter') addTask()">
                        <button class="btn-add" onclick="addTask()"><i class="ph ph-plus"></i></button>
                    </div>
                </div>`;
                if(db.inbox.length > 0) html += `<button class="btn-wizard" onclick="startWizard()"><i class="ph ph-lightning"></i> –†–∞–∑–æ–±—Ä–∞—Ç—å –ò–Ω–±–æ–∫—Å (${db.inbox.length})</button>`;
            }

            html += `<div class="task-list">`;
            const list = db[currentView] || [];
            
            if(list.length === 0) {
                html += `<div style="text-align:center; color:var(--text-secondary); margin-top:60px; font-size:15px; opacity:0.6;"><i class="ph ph-coffee" style="font-size:40px; margin-bottom:10px; display:block;"></i>–ó–∞–¥–∞—á –Ω–µ—Ç</div>`;
            } else {
                if (currentView === 'done') {
                    const doneProjects = list.filter(i => i.isProject);
                    const doneTasks = list.filter(i => !i.isProject);
                    if (doneProjects.length > 0) {
                        html += `<div class="section-title">–ü—Ä–æ–µ–∫—Ç—ã</div>`;
                        doneProjects.forEach(item => { html += createCard(item, true, true); });
                    }
                    if (doneTasks.length > 0) {
                         html += `<div class="section-title">–ó–∞–¥–∞—á–∏</div>`;
                         doneTasks.forEach(item => { html += createCard(item, true, false); });
                    }
                } else if (currentView === 'projects') {
                     list.forEach(item => {
                        if(!item.steps) item.steps = [];
                        const activeStep = item.steps.find(s => !s.completed);
                        const progress = item.steps.filter(s=>s.completed).length + '/' + item.steps.length;
                        html += `
                        <div class="task-card" style="display:block;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                                <div style="font-weight:700; font-size:17px; color:var(--text-main);"><i class="ph ph-folder-notch"></i> ${item.title}</div>
                                <div class="actions">
                                    <button class="btn-action" onclick="editProject(${item.id})"><i class="ph ph-pencil-simple"></i></button>
                                    <button class="btn-action delete" onclick="moveToTrash('${currentView}', ${item.id})"><i class="ph ph-trash"></i></button>
                                </div>
                            </div>
                            <div style="font-size:14px; color:var(--text-secondary); margin-bottom:12px;">üéØ ${item.goal}</div>
                            <div style="background:#F8FAFC; padding:12px; border-radius:12px; font-size:14px; display:flex; justify-content:space-between; align-items:center;">
                                <span style="display:flex; gap:8px; align-items:center;"><i class="ph ph-footprints" style="color:var(--primary-color)"></i> ${activeStep ? activeStep.text : '–ì–æ—Ç–æ–≤–æ!'}</span>
                                <span style="font-size:12px; font-weight:600; color:var(--text-secondary);">${progress}</span>
                            </div>
                        </div>`;
                      });
                } else {
                    list.forEach(item => { html += createCard(item, false, false); });
                }
            }
            html += `</div>`;
            container.innerHTML = html;
            updateBadges();
        }

        window.createCard = function(item, isDoneView, isProjectCard) {
            let metaHtml = '';
            if(item.isQuick) metaHtml += `<span class="tag quick"><i class="ph-fill ph-lightning"></i> 2 –º–∏–Ω</span>`;
            if(item.dateStr) metaHtml += `<span class="tag date"><i class="ph-fill ph-calendar"></i> ${formatDateRUS(item.dateStr)}</span>`;
            if(item.timeStr) metaHtml += `<span class="tag date"><i class="ph-fill ph-clock"></i> ${item.timeStr}</span>`;
            if(item.assignee) metaHtml += `<span class="tag project"><i class="ph-fill ph-user"></i> ${item.assignee}</span>`;
            if(item.projectTitle) metaHtml += `<span class="tag project"><i class="ph-fill ph-folder"></i> ${item.projectTitle}</span>`;

            let buttons = '';
            if(!['trash','done'].includes(currentView)) buttons += `<button class="btn-action" onclick="openMoveModal(${item.id})"><i class="ph ph-folder-notch-open"></i></button>`;
            
            if(currentView === 'trash') {
                buttons += `<button class="btn-action" onclick="restoreFromTrash(${item.id})"><i class="ph ph-arrow-u-up-left"></i></button><button class="btn-action delete" onclick="permanentDelete(${item.id})"><i class="ph ph-x"></i></button>`;
            } else if (isDoneView) {
                buttons += `<button class="btn-action" onclick="undoComplete(${item.id})"><i class="ph ph-arrow-u-up-left"></i></button>`;
            } else {
                buttons += `<button class="btn-action delete" onclick="moveToTrash('${currentView}', ${item.id})"><i class="ph ph-trash"></i></button>`;
            }

            const displayTitle = item.title || item.text;
            const checkAction = `completeTask('${currentView}', ${Number(item.id)})`;
            
            let checkboxHtml = '';
            if(['today','calendar','inbox'].includes(currentView)) {
                checkboxHtml = `<div class="task-check" onclick="${checkAction}"><i class="ph-bold ph-check"></i></div>`;
            } else if (isDoneView) {
                checkboxHtml = `<div class="task-check checked"><i class="ph-bold ph-check"></i></div>`;
            }

            return `
            <div class="task-card">
                <div class="task-left">
                    ${checkboxHtml}
                    <div class="task-content">
                        <div class="task-title" style="${isDoneView?'text-decoration:line-through; opacity:0.5':''}">${displayTitle}</div>
                        <div class="task-meta">${metaHtml}</div>
                    </div>
                </div>
                <div class="actions">${buttons}</div>
            </div>`;
        }

        // --- ACTIONS ---
        window.addTask = function() {
            window.haptic('light');
            const val = document.getElementById('main-input').value.trim();
            if(!val) return;
            if(!db.inbox) db.inbox = [];
            db.inbox.unshift({ id: Date.now(), text: val, created: new Date().toISOString(), isProject: false });
            document.getElementById('main-input').value = '';
            saveDB();
        }

        window.moveToTrash = function(from, id) { 
            window.haptic('medium'); 
            const idx = db[from].findIndex(t => t.id === id); 
            if(idx > -1) { 
                const item = db[from].splice(idx, 1)[0]; 
                item.originalFolder = from; 
                if(!db.trash) db.trash = [];
                db.trash.unshift(item); 
                saveDB(); 
            } 
        }
        window.restoreFromTrash = function(id) { window.haptic('light'); const idx = db.trash.findIndex(t => t.id === id); if(idx > -1) { const item = db.trash.splice(idx, 1)[0]; db[item.originalFolder || 'inbox'].push(item); saveDB(); } }
        window.permanentDelete = function(id) { window.haptic('heavy'); if(confirm("–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?")) { db.trash = db.trash.filter(t => t.id !== id); saveDB(); } }
        window.emptyTrash = function() { window.haptic('heavy'); if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?")) { db.trash = []; saveDB(); } }
        window.undoComplete = function(id) { window.haptic('light'); const idx = db.done.findIndex(t => t.id === id); if(idx > -1) { const item = db.done.splice(idx, 1)[0]; delete item.completedAt; if(item.isProject) db.projects.unshift(item); else db.today.unshift(item); saveDB(); } }

        window.completeTask = function(from, id) {
            window.haptic('success');
            id = Number(id);
            const idx = db[from].findIndex(t => t.id === id); 
            if(idx === -1) return; 
            
            const task = db[from][idx];

            if (task.projectId) {
                const project = db.projects.find(p => p.id === task.projectId);
                if (project) {
                    const step = project.steps.find(s => s.id === task.stepId);
                    if(step) step.completed = true;
                    
                    const nextStep = project.steps.find(s => !s.completed);
                    if(nextStep) {
                        alert(`–û—Ç–ª–∏—á–Ω–æ! –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: "${nextStep.text}"`);
                        db.today.push({ id: Date.now(), text: nextStep.text, projectId: project.id, projectTitle: project.title, stepId: nextStep.id, isProject: false });
                    } else {
                        alert("üéâ –ü—Ä–æ–µ–∫—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!");
                        db.projects = db.projects.filter(p => p.id !== project.id);
                        project.isProject = true; project.completedAt = new Date().toLocaleString();
                        if(!db.done) db.done = [];
                        db.done.unshift(project);
                    }
                }
                db[from].splice(idx, 1);
            } else {
                const item = db[from].splice(idx, 1)[0];
                item.completedAt = new Date().toLocaleString();
                if(!db.done) db.done = [];
                db.done.unshift(item);
            }
            saveDB();
        }

        // --- WIZARD LOGIC ---
        let wizardTask=null, wizardStep=0, inputCallback=null, dateCallback=null, moveTaskId=null;
        const questions = [
            { text: "–ù—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å?", no: "reference", noTxt: "–ù–µ—Ç (–ê—Ä—Ö–∏–≤)", yesTxt: "–î–∞" },
            { text: "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ?", no: "someday", noTxt: "–ù–µ—Ç (–ü–æ—Ç–æ–º)", yesTxt: "–î–∞" },
            { text: "–î–µ–ª–∞—Ç—å –ú–ù–ï?", no: "DELEGATE", noTxt: "–ù–µ—Ç (–ü–æ—Ä—É—á–∏—Ç—å)", yesTxt: "–î–∞" },
            { text: "–≠—Ç–æ 1 —à–∞–≥?", no: "PROJECT", noTxt: "–ù–µ—Ç (–ü—Ä–æ–µ–∫—Ç)", yesTxt: "–î–∞" },
            { text: "< 2 –º–∏–Ω—É—Ç?", yes: "DO_NOW", yesTxt: "–î–∞ (–°–µ–π—á–∞—Å)", noTxt: "> 2 –º–∏–Ω" },
            { text: "–ñ–µ—Å—Ç–∫–∞—è –¥–∞—Ç–∞?", yes: "CALENDAR", yesTxt: "–î–∞ (–ö–∞–ª–µ–Ω–¥–∞—Ä—å)", noTxt: "–ù–µ—Ç (–í –°–µ–≥–æ–¥–Ω—è)" }
        ];

        window.startWizard = function() { 
            if(db.inbox.length===0) return; 
            window.haptic('light'); wizardTask=db.inbox[0]; wizardStep=0; 
            document.getElementById('wizard-modal').style.display='flex'; renderWizard(); 
        }
        window.renderWizard = function() {
            const q = questions[wizardStep];
            document.getElementById('wizard-task-text').innerText = wizardTask.text;
            document.getElementById('wizard-question-text').innerText = q.text;
            document.getElementById('btn-no').innerText = q.noTxt;
            document.getElementById('btn-yes').innerText = q.yesTxt;
        }
        window.handleWizardAnswer = function(yes) {
            window.haptic('light');
            const q = questions[wizardStep];
            if(!yes) {
                if(q.no==='reference') return moveTo('reference');
                if(q.no==='someday') return moveTo('someday');
                if(q.no==='DELEGATE') { openInput('–ö–æ–º—É?', (n)=>{ setTimeout(()=>openDateModal((d)=>moveTo('waiting',{assignee:n, dateStr:d})),200); }); return; }
                if(q.no==='PROJECT') { openProjectModal(null, wizardTask); return; }
            } else {
                if(q.yes==='DO_NOW') { 
                    moveTo('today', { isQuick: true }); 
                    alert("‚ö°Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ '–°–µ–≥–æ–¥–Ω—è' (2 –ú–ò–ù). –°–¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ —Å–µ–π—á–∞—Å!");
                    return; 
                }
                if(q.yes==='CALENDAR') { openDateModal((d,t)=>moveTo('calendar',{dateStr:d, timeStr:t})); return; }
            }
            wizardStep++; if(wizardStep>=questions.length) moveTo('today'); else renderWizard();
        }
        window.moveTo = function(f, e={}) { db.inbox.shift(); if(!db[f]) db[f]=[]; db[f].unshift({...wizardTask, ...e, id:Date.now()}); saveDB(); closeModal('wizard-modal'); closeModal('input-modal'); closeModal('date-modal'); if(db.inbox.length>0) setTimeout(startWizard,300); }

        window.closeModal = function(id) { document.getElementById(id).style.display='none'; }
        window.openInput = function(t, cb) { document.getElementById('input-modal').style.display='flex'; document.getElementById('input-modal-title').innerText=t; inputCallback=cb; }
        window.submitInputModal = function() { const v=document.getElementById('input-modal-field').value; if(v&&inputCallback) inputCallback(v); closeModal('input-modal'); }
        window.openDateModal = function(cb) { document.getElementById('date-modal').style.display='flex'; dateCallback=cb; }
        window.submitDateModal = function() { const d=document.getElementById('calendar-date').value; const t=document.getElementById('calendar-time').value; if(d&&dateCallback) dateCallback(d,t); closeModal('date-modal'); }
        window.openMoveModal = function(id) { moveTaskId=id; document.getElementById('move-modal').style.display='flex'; }
        window.submitMove = function(f) { if(!moveTaskId)return; const idx=db[currentView].findIndex(t=>t.id===moveTaskId); if(idx>-1) { const i=db[currentView].splice(idx,1)[0]; if(!db[f]) db[f]=[]; db[f].unshift(i); saveDB(); } closeModal('move-modal'); }

        // --- PROJECTS AND LIMITS ---
        let tempSteps=[];
        window.openProjectModal = function(eid=null, src=null) {
            closeModal('wizard-modal'); document.getElementById('project-modal').style.display='flex'; tempSteps=[];
            if(eid) { const p=db.projects.find(x=>x.id===eid); document.getElementById('proj-edit-id').value=eid; document.getElementById('proj-name').value=p.title; document.getElementById('proj-goal').value=p.goal; tempSteps=JSON.parse(JSON.stringify(p.steps)); }
            else { document.getElementById('proj-edit-id').value=""; document.getElementById('proj-name').value=src.text; document.getElementById('proj-goal').value=""; }
            renderSteps();
        }
        window.addStepToUI = function() { const v=document.getElementById('proj-new-step').value; if(v) { tempSteps.push({id:Date.now(), text:v, completed:false}); document.getElementById('proj-new-step').value=''; renderSteps(); } }
        window.removeStep = function(i) { tempSteps.splice(i,1); renderSteps(); }
        window.renderSteps = function() { const c=document.getElementById('proj-steps-container'); c.innerHTML=''; tempSteps.forEach((s,i)=>{ c.innerHTML+=`<div class="step-row"><span>${i+1}.</span><input value="${s.text}" oninput="updateStep(${i},this.value)" style="border:none; background:transparent; font-size:15px; width:100%; outline:none;"><i class="ph ph-x" style="color:red; font-size:18px; padding:5px; cursor:pointer;" onclick="removeStep(${i})"></i></div>`; }); }
        window.updateStep = function(i,v) { tempSteps[i].text=v };
        
        window.saveProject = function() {
            window.haptic('success');
            const eid=document.getElementById('proj-edit-id').value; 
            
            // CHECK LIMITS FOR NEW PROJECTS
            if (!eid) {
                if (!checkPremiumLimits()) return;
            }

            const t=document.getElementById('proj-name').value; 
            const g=document.getElementById('proj-goal').value;
            
            if(!t||!g||tempSteps.length===0) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–ª—å –∏ —à–∞–≥–∏!");
            
            if(eid) { const i=db.projects.findIndex(p=>p.id==eid); if(i>-1) { db.projects[i].title=t; db.projects[i].goal=g; db.projects[i].steps=tempSteps; } }
            else { 
                const nid=Date.now(); 
                if(!db.projects) db.projects = [];
                db.projects.push({id:nid, title:t, goal:g, steps:tempSteps, isProject:true}); 
                if(wizardTask) {
                     if(!db.inbox) db.inbox = [];
                     db.inbox=db.inbox.filter(x=>x.id!==wizardTask.id); 
                }
                if(!db.today) db.today = [];
                db.today.push({id:Date.now()+1, text:tempSteps[0].text, projectId:nid, projectTitle:t, stepId:tempSteps[0].id, isProject:false}); 
            }
            saveDB(); closeModal('project-modal'); if(!eid&&db.inbox.length>0) setTimeout(startWizard,300);
        }
        window.editProject = function(id) { openProjectModal(id); }

        window.updateBadges = function() { 
            for(let k in db) { 
                const el=document.getElementById('badge-'+k); if(el) el.innerText=db[k] ? db[k].length : 0; 
                const mel=document.getElementById('mob-badge-'+k); if(mel) mel.innerText=(db[k] && db[k].length>0) ? `(${db[k].length})`:'';
            } 
        }

        // START
        initUserInfo();
        switchView('inbox');
    </script>
</body>
</html>
